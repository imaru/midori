---
title: "midori4"
author: "Toshihide Imaruoka"
date: "6/14/2022"
output:
  rmdformats::downcute:
    highlight: kate
    css: mycss.css
    dev: "ragg_png"
---
# 4. GLMのモデル選択--AICとモデルの予測の良さ--
  * 良いモデルはあてはまりの良いモデルではない
    * 複雑なモデルほど当てはまるから
    * あまりにパラメータが多いモデルはおそらく妥当ではない
  * モデル選択
    * 複数の統計モデルから「良い」モデルを選ぶ
    * いろいろな方法＝基準
  * AICというモデル選択基準
    * 良い予測をするモデルが良いモデル
    * ×当てはまりの良さに基づく選択
  * 4.3までで一応の説明
  * 4.4以降は難易度高い（飛ばしてもOK）
  
## 4.1 データは一つ、モデルはたくさん
  * 第3章のデータ
    * 種子数と体サイズと施肥処理
  * モデル
    * 体サイズが影響するモデル($y\sim x+\beta$)
    * 施肥処理が影響するモデル($y\sim f+\beta$)
    * 体サイズと施肥処理が影響するモデル（$y\sim x+f+\beta$)
    * 一定モデル($f\sim \beta$)
  * 3章では対数尤度を最大にするパラメータを求め、そのパラメータに対する対数尤度＝最大対数尤度が当てはまりの良さだとした
    * 最大対数尤度をもっとも大きいモデルが良いモデル？
    * そうではない、という話。
    
## 4.2 統計モデルのあてはまりの悪さ：逸脱度
  * 逸脱度(deviance)
    * 最大対数尤度を変形した統計量
    * 対数尤度：$logL({\beta_j})$←あるパラメータ$\beta_j$のときの対数尤度。簡単のため$logL$と表す
    * 最大対数尤度：$logL$を最大にするパラメータ$\beta_j$のときの$logL$：$logL^*$とする
    * 逸脱度D
      * $D=-2logL^*$
  * ここから例
    * 体サイズだけのモデルをxモデルと呼ぶ
      * xモデルの最大対数尤度$logL^*$は-235.4
      * D=470.8
    * glm()の結果にこんな値はない。どこにいった？
    
```{r}
dat<-read.csv('kubobook_2012-2/poisson/data3a.csv')
dat$f<-as.factor(dat$f)
f.x<-glm(y~x, data=dat, family=poisson)
print(f.x)
logLik(f.x)
D.x<-logLik(f.x)[1]*-2
print(D.x)
```
   
  * 表示されてるのは以下のような値
    * Null Deviance 
    * Residual Deviance
    * AIC
  * まずはResidual Deviance（残差逸脱度）の説明
    * 残差逸脱度＝逸脱度$D$-（ポアソン分布モデルで可能な最小逸脱度）
    * 最小逸脱度：最多のパラメータを使った作ったモデル
      * データ100個の場合、パラメータ100個とする（意味はない）
      * 意味はないけど、当てはまりは良い
      * 最大対数尤度を計算
        * dpois(dat$y[1], dat$y[1])は、データがポアソン分布に従っているとして、ラムダがdat$y[1]のときに、データがdat$y[1]である確率のこと（0.16くらいになる）
        * データとパラメータが一致するので、これは考えられる中で最も高い確率。
        * その対数を全データ（100個）分足した数
        * これは他のどんなモデルよりも小さくなるはず（確率は大きいけど対数を取るから小さい）
        * これがポアソン分布で可能な最小逸脱度（今の場合、下の計算のように385.8くらいになる
        * xモデルのD（470.8）と最小逸脱度（385.8）の差が、xモデルの残差逸脱度（84.993）
      
```{r}
D.min<-sum(log(dpois(dat$y, lambda=dat$y))) * -2
D.x-D.min
```

  * 残差逸脱度：最小逸脱度を基準にした、あてはまりの悪さの相対値
  * 次に最大の逸脱度について考えてみる（図4.3の一番上）
    * もっとも当てはまりの悪いモデルのときに逸脱度は最大のはず
    * 切片だけで作られたモデルがそれにあたる
    * 最大の逸脱度は475.3くらいで、最小との差は89.5くらい
      * これがNull Deviance
  * このあたりのまとめ：表4.2
    * パラメータが増えるとあてはまりが良い
    
```{r}
f.null<-glm(y~1, data=dat, family=poisson)
print(f.null)
print(logLik(f.null)[1]*-2-D.min) # このモデルの逸脱度とフルモデルの逸脱度の差
```

## 4.3 モデル選択基準AIC
  * モデルのあてはまりが良くても、パラメータが多いと「今の」データへの特殊化をしているだけかも
    * 予測の良さを損なうかも
  * AIC: モデル選択基準の一つ
    * 予測の良さを重視するモデル選択基準
    * $AIC = -2{(最大対数尤度)-(最尤推定したパラメータ数)}$
      * = $-2(logL^*-k)$
      * = $D+2k$
        * $logL^*$は-D/2だから($D=-2logL^*$ p71)
    * これで計算するとxモデルがAIC最小となる（表4.3）
  
    