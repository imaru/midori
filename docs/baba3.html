<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />

        <meta name="author" content="Toshihide Imaruoka" />
    
    
    <title>馬場本</title>

        <script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
        <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="site_libs/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <script src="site_libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
        <script src="site_libs/navigation-1.1/tabsets.js"></script>
        <link href="site_libs/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
        <script src="site_libs/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
        <link href="site_libs/downcute-0.1/downcute.css" rel="stylesheet" />
        <link href="site_libs/downcute-0.1/downcute_fonts_embed.css" rel="stylesheet" />
        <script src="site_libs/downcute-0.1/downcute_styles.js"></script>
        <script src="site_libs/downcute-0.1/downcute.js"></script>
        <script src="site_libs/prism-1.22/prism.js"></script>
    
    
    
        <link rel="stylesheet" href="mycss.css" type="text/css" />
    
    <!-- tabsets -->
    <script>
      $(document).ready(function () {
	  window.buildTabsets("toc");
      });
      $(document).ready(function () {
	  $('.tabset-dropdown > .nav-tabs > li').click(function () {
	      $(this).parent().toggleClass('nav-tabs-open')
	  });
      });
    </script>

    <!-- code folding -->
    
    <!-- code download -->
    
    <!-- tabsets dropdown -->

    <style type="text/css">
      .tabset-dropdown > .nav-tabs {
	  display: inline-table;
	  max-height: 500px;
	  min-height: 44px;
	  overflow-y: auto;
	  background: white;
	  border: 1px solid #ddd;
	  border-radius: 4px;
      }
      
      .tabset-dropdown > .nav-tabs > li.active:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
	  content: "&#xe258;";
	  border: none;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs > li.active {
	  display: block;
      }

      .tabset-dropdown > .nav-tabs > li.active a {
  	  padding: 0 15px !important;
      }

      .tabset-dropdown > .nav-tabs > li > a,
      .tabset-dropdown > .nav-tabs > li > a:focus,
      .tabset-dropdown > .nav-tabs > li > a:hover {
	  border: none;
	  display: inline-block;
	  border-radius: 4px;
	  background-color: transparent;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
	  display: block;
	  float: none;
      }
      
      .tabset-dropdown > .nav-tabs > li {
	  display: none;
	  margin-left: 0 !important;
      }
    </style>
    
</head>

<body class="preload">

   	
               <!-- downcute start -->   
   <div id="docute" class="Root theme-default">
     <div class="Page layout-narrow">
      <div class="Wrap">
        <div class="Sidebar">
          <div class="SidebarItems" id="toc">
            <ul>
            <li><a href="#章">3章</a></li>
            <li><a href="#章-一般化線形モデルの基本">3-1章: 一般化線形モデルの基本</a>
            <ul>
            <li><a href="#目的と概要">1. 目的と概要</a></li>
            <li><a href="#複雑なモデルを構築する際の手続きの標準化">2. 複雑なモデルを構築する際の手続きの標準化</a></li>
            <li><a href="#確率分布線形予測子リンク関数">3. 確率分布・線形予測子・リンク関数</a></li>
            <li><a href="#一般化線形モデルの例-説明変数が無く正規分布を仮定するモデル">4. 一般化線形モデルの例: 説明変数が無く、正規分布を仮定するモデル</a></li>
            <li><a href="#単回帰モデル-説明変数が1つだけあり正規分布を仮定するモデル">5. 単回帰モデル: 説明変数が1つだけあり、正規分布を仮定するモデル</a></li>
            <li><a href="#分散分析モデルダミー変数を利用するモデル">6. 分散分析モデル：ダミー変数を利用するモデル</a></li>
            <li><a href="#正規線形モデル正規分布を仮定するモデル">7. 正規線形モデル：正規分布を仮定するモデル</a></li>
            <li><a href="#ポアソン回帰モデル">8. ポアソン回帰モデル</a></li>
            <li><a href="#ロジスティック回帰モデル-二項分布を仮定するモデル">9. ロジスティック回帰モデル: 二項分布を仮定するモデル</a></li>
            <li><a href="#一般化線形モデルの行列表現">10. 一般化線形モデルの行列表現</a></li>
            <li><a href="#補足データの表記とベクトル行列">11. 補足：データの表記とベクトル・行列</a></li>
            <li><a href="#補足行列の基本的な演算">12. 補足：行列の基本的な演算</a></li>
            <li><a href="#行列の掛け算">13. 行列の掛け算</a></li>
            <li><a href="#一般化線形モデルのさまざまなトピック">14. 一般化線形モデルのさまざまなトピック</a></li>
            <li><a href="#例題-伊丸岡研の希望人数に実験科目を担当していたかがどう影響するか">例題: 伊丸岡研の希望人数に実験科目を担当していたかがどう影響するか</a></li>
            <li><a href="#目的と概要-1">2.1 目的と概要</a></li>
            <li><a href="#分析の準備">2.2 分析の準備</a></li>
            <li><a href="#データ読み込みと可視化">2.3 データ読み込みと可視化</a></li>
            <li><a href="#モデルの構造">2.4 モデルの構造</a></li>
            <li><a href="#単回帰モデルのためのstanファイルの実装">2.5 単回帰モデルのためのStanファイルの実装</a></li>
            <li><a href="#mcmcの実行-2.7-事後分布の可視化">2.6 MCMCの実行, 2.7 事後分布の可視化</a></li>
            <li><a href="#まとめ">2.8 まとめ</a></li>
            </ul></li>
            <li><a href="#章-一般化線形モデルの基本-1">3-1章: 一般化線形モデルの基本</a>
            <ul>
            <li><a href="#目的と概要-2">1. 目的と概要</a></li>
            <li><a href="#複雑なモデルを構築する際の手続きの標準化-1">2. 複雑なモデルを構築する際の手続きの標準化</a></li>
            <li><a href="#確率分布線形予測子リンク関数-1">3. 確率分布・線形予測子・リンク関数</a></li>
            <li><a href="#一般化線形モデルの例-説明変数が無く正規分布を仮定するモデル-1">4. 一般化線形モデルの例: 説明変数が無く、正規分布を仮定するモデル</a></li>
            <li><a href="#単回帰モデル-説明変数が1つだけあり正規分布を仮定するモデル-1">5. 単回帰モデル: 説明変数が1つだけあり、正規分布を仮定するモデル</a></li>
            <li><a href="#分散分析モデルダミー変数を利用するモデル-1">6. 分散分析モデル：ダミー変数を利用するモデル</a></li>
            <li><a href="#正規線形モデル正規分布を仮定するモデル-1">7. 正規線形モデル：正規分布を仮定するモデル</a></li>
            <li><a href="#ポアソン回帰モデル-1">8. ポアソン回帰モデル</a></li>
            <li><a href="#ロジスティック回帰モデル-二項分布を仮定するモデル-1">9. ロジスティック回帰モデル: 二項分布を仮定するモデル</a></li>
            </ul></li>
            <li><a href="#章-単回帰モデル">3-2章: 単回帰モデル</a>
            <ul>
            <li><a href="#分析の準備---8.-まとめ">2. 分析の準備 - 8. まとめ</a></li>
            </ul></li>
            <li><a href="#章-モデルを用いた予測">3-3章: モデルを用いた予測</a>
            <ul>
            <li><a href="#分析の準備-1">2. 分析の準備</a></li>
            <li><a href="#単回帰モデルにおける予測の考え方">3. 単回帰モデルにおける予測の考え方</a></li>
            <li><a href="#予測のためのデータの整理">4. 予測のためのデータの整理</a></li>
            <li><a href="#予測のためのstanファイルの修正">5. 予測のためのStanファイルの修正</a></li>
            <li><a href="#mcmcの実行">6. MCMCの実行</a></li>
            <li><a href="#予測分布の可視化">7. 予測分布の可視化</a></li>
            </ul></li>
            <li><a href="#章-デザイン行列を用いた一般化線形モデルの推定">3-4章: デザイン行列を用いた一般化線形モデルの推定</a>
            <ul>
            <li><a href="#分析の準備-2">2. 分析の準備</a></li>
            <li><a href="#デザイン行列を使ったモデルの数学的な表現">3. デザイン行列を使ったモデルの数学的な表現</a></li>
            <li><a href="#formula構文を用いたデザイン行列の作成">4. formula構文を用いたデザイン行列の作成</a></li>
            <li><a href="#デザイン行列を使うためのstanファイルの設定">5. デザイン行列を使うためのStanファイルの設定</a></li>
            <li><a href="#mcmcの実行-1">6. MCMCの実行</a></li>
            </ul></li>
            <li><a href="#brmsの使い方">3-5. brmsの使い方</a>
            <ul>
            <li><a href="#brmsとは">2. brmsとは</a></li>
            <li><a href="#本書での実装の方針">3. 本書での実装の方針</a></li>
            <li><a href="#分析の準備-3">4. 分析の準備</a></li>
            <li><a href="#brmsによる単回帰モデルの推定">5. brmsによる単回帰モデルの推定</a></li>
            <li><a href="#brmsの基本的な使い方">6. brmsの基本的な使い方</a></li>
            <li><a href="#事前分布の変更">7. 事前分布の変更</a></li>
            <li><a href="#補足brmsの基本的な仕組み">8. 補足：brmsの基本的な仕組み</a></li>
            <li><a href="#補足make_stancode関数によるstanコードの作成">9. 補足：make_stancode関数によるStanコードの作成</a></li>
            <li><a href="#補足make_standata関数によるstanに渡すデータの作成">10. 補足：make_standata関数による、Stanに渡すデータの作成</a></li>
            <li><a href="#補足rstanでbrmsの結果を再現する">11. 補足：rstanでbrmsの結果を再現する</a></li>
            <li><a href="#brmsによる事後分布の可視化">12. brmsによる事後分布の可視化</a></li>
            <li><a href="#brmsによる予測">13. brmsによる予測</a></li>
            <li><a href="#補足predict関数を使わない予測の実装">14. 補足：predict関数を使わない予測の実装</a></li>
            <li><a href="#回帰直線の図示">15. 回帰直線の図示</a></li>
            <li><a href="#反応時間練習問題">反応時間練習問題</a></li>
            </ul></li>
            <li><a href="#章-ダミー変数と分散分析モデル">3-6章: ダミー変数と分散分析モデル</a>
            <ul>
            <li><a href="#モデルの構造-1">2. モデルの構造</a></li>
            <li><a href="#brmsによる分散分析モデルの推定">5. brmsによる分散分析モデルの推定</a></li>
            <li><a href="#補足-分散分析モデルのデザイン行列">6. 補足: 分散分析モデルのデザイン行列</a></li>
            </ul></li>
            <li><a href="#正規線形モデル">3-7: 正規線形モデル</a>
            <ul>
            <li><a href="#モデルの構造-2">2. モデルの構造</a></li>
            <li><a href="#分析の準備-4">3. 分析の準備</a></li>
            <li><a href="#データの読み込み">4. データの読み込み</a></li>
            <li><a href="#brmsによる正規線形モデルの推定">5. brmsによる正規線形モデルの推定</a></li>
            <li><a href="#補足正規線形モデルのデザイン行列stanによる解析">6. 補足：正規線形モデルのデザイン行列（Stanによる解析）</a></li>
            </ul></li>
            <li><a href="#ポアソン回帰モデル-2">3-8: ポアソン回帰モデル</a>
            <ul>
            <li><a href="#モデルの構造-3">2. モデルの構造</a></li>
            <li><a href="#分析の準備-5">3. 分析の準備</a></li>
            <li><a href="#データの読み込みと可視化">4. データの読み込みと可視化</a></li>
            <li><a href="#brmsによるポアソン回帰モデルの推定">5. brmsによるポアソン回帰モデルの推定</a></li>
            <li><a href="#推定されたモデルの解釈">6. 推定されたモデルの解釈</a></li>
            <li><a href="#回帰曲線の図示">7. 回帰曲線の図示</a></li>
            <li><a href="#補足ポアソン回帰モデルのためのstanファイルの実装">8. 補足：ポアソン回帰モデルのためのStanファイルの実装</a></li>
            </ul></li>
            <li><a href="#ロジスティック回帰モデル">3-9. ロジスティック回帰モデル</a>
            <ul>
            <li><a href="#モデルの構造-4">2. モデルの構造</a></li>
            <li><a href="#分析の準備-6">3. 分析の準備</a></li>
            <li><a href="#データの読み込みと可視化-1">4. データの読み込みと可視化</a></li>
            <li><a href="#brmsによるロジスティック回帰モデルの推定">5. brmsによるロジスティック回帰モデルの推定</a></li>
            <li><a href="#回帰曲線の図示-1">7. 回帰曲線の図示</a></li>
            <li><a href="#補足-ロジスティック回帰のためのstanファイルの実装">8. 補足: ロジスティック回帰のためのStanファイルの実装</a></li>
            </ul></li>
            </ul>
          </div>
          <div data-position="sidebar:post-end" class="InjectedComponents"><div class="dark-theme-toggler"><div class="toggle "><div class="toggle-track"><div class="toggle-track-check"><img  src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div> <div class="toggle-track-x"><img src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div></div> <div class="toggle-thumb"></div></div> <input type="checkbox" aria-label="Switch between Dark and Default theme" class="toggler-screen-reader-only"></div></div>
        </div>
        <div class="Main">
          <div class="Content" id="content"> 
   
   
      
      <div class="navbar navbar-default  navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">my public memo</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li>
        <a href="index.html">Home</a>
      </li>
      <li>
        <a href="baba1.html">馬場本1章</a>
      </li>
      <li>
        <a href="baba2.html">馬場本2章</a>
      </li>
      <li>
        <a href="baba3.html">馬場本3章</a>
      </li>
      <li>
        <a href="psytech.html">技術部</a>
      </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container -->
      </div><!--/.navbar -->
        
      <h1 class="title">馬場本</h1>
      
      <p class="authors">
           <span class="glyphicon glyphicon-user"></span> Toshihide Imaruoka
      </p>
              

   
      
   
<!-- Don't indent these lines or it will mess pre blocks indentation --> 
<div class="page-content has-page-title">
<div id="章" class="section level1">
<h1>3章</h1>
</div>
<div id="章-一般化線形モデルの基本" class="section level1">
<h1>3-1章: 一般化線形モデルの基本</h1>
<div id="目的と概要" class="section level2">
<h2>1. 目的と概要</h2>
<ul>
<li>一般化線形モデル(GLM): 実践的モデル &amp; 複雑なモデルの部品</li>
<li>確率分布、線形予測子、リンク関数</li>
<li>リファレンス的に使える章</li>
</ul>
</div>
<div id="複雑なモデルを構築する際の手続きの標準化" class="section level2">
<h2>2. 複雑なモデルを構築する際の手続きの標準化</h2>
<ul>
<li>モデルをどう構築するか</li>
<li>ビールの売り上げの例
<ul>
<li><span class="math inline">\(y \sim Normal(\mu,\sigma^2)\)</span></li>
<li>これを複雑にしようとしたとき、“勝手に”やるばかりだと非効率かも</li>
<li>「モデルの方」「フレームワーク」</li>
</ul></li>
<li>一般化線形モデルにおけるモデルの変更手続き
<ol style="list-style-type: decimal">
<li>確率分布を変える</li>
<li>線形予測子を変える</li>
<li>リンク関数を変える</li>
</ol></li>
</ul>
</div>
<div id="確率分布線形予測子リンク関数" class="section level2">
<h2>3. 確率分布・線形予測子・リンク関数</h2>
<ul>
<li>確率分布
<ul>
<li>観測データを生む確率的過程を表現するためのもの。データに合わせて変える。
<ul>
<li>ビールなら正規分布</li>
<li>小動物の数ならポアソン分布</li>
<li>購入比率なら二項分布</li>
</ul></li>
</ul></li>
<li>変数
<ul>
<li>応答変数・従属変数</li>
<li>説明変数</li>
</ul></li>
<li>線形予測子
<ul>
<li>説明変数の線型結合</li>
</ul></li>
<li>リンク関数
<ul>
<li>応答変数と線形予測子を関係付けること</li>
</ul></li>
</ul>
</div>
<div id="一般化線形モデルの例-説明変数が無く正規分布を仮定するモデル" class="section level2">
<h2>4. 一般化線形モデルの例: 説明変数が無く、正規分布を仮定するモデル</h2>
<ul>
<li>ビール売り上げの例
<ul>
<li>凡例
<ul>
<li><span class="math inline">\(y_i\)</span>:売り上げデータ</li>
<li><span class="math inline">\(\mu_i\)</span>: <span class="math inline">\(y_i\)</span>の期待値</li>
<li><span class="math inline">\(_i\)</span>: 何番目のデータか</li>
<li><span class="math inline">\(g\)</span>: 恒等関数（<span class="math inline">\(g(y)=y\)</span>となる関数=何も起きない関数）</li>
</ul></li>
<li>一般化線形モデル
<ul>
<li><span class="math inline">\(g(\mu_i)=\beta_0\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu, \sigma^2)\)</span></li>
<li><span class="math inline">\(\beta_0\)</span>が線形予測子、恒等関数<span class="math inline">\(g()\)</span>がリンク関数</li>
</ul></li>
<li>書き換え
<ul>
<li><span class="math inline">\(\mu_i=\beta_0\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu, \sigma^2)\)</span></li>
</ul></li>
<li>従属変数の平均値<span class="math inline">\(\mu_i\)</span>が値<span class="math inline">\(\beta_0\)</span>をとることを想定したモデル</li>
</ul></li>
</ul>
</div>
<div id="単回帰モデル-説明変数が1つだけあり正規分布を仮定するモデル" class="section level2">
<h2>5. 単回帰モデル: 説明変数が1つだけあり、正規分布を仮定するモデル</h2>
<ul>
<li>ビールの売り上げが気温<span class="math inline">\(x\)</span>によって変化するというモデル
<ul>
<li><span class="math inline">\(g(\mu_i)=\beta_0+\beta_1x_i\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu_i, \sigma^2)\)</span></li>
<li><span class="math inline">\(\beta_0+\beta_1x_i\)</span>が線形予測子、恒等関数<span class="math inline">\(g()\)</span>がリンク関数</li>
</ul></li>
<li>書き換え
<ul>
<li><span class="math inline">\(\mu_i = \beta_0 + \beta_1x_i\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu_i, \sigma^2)\)</span></li>
</ul></li>
<li>気温<span class="math inline">\(x\)</span>が1変化すると<span class="math inline">\(\beta_1\)</span>増減する</li>
<li>単回帰モデル
<ul>
<li><span class="math inline">\(\beta_0\)</span>を切片</li>
<li><span class="math inline">\(\beta_1\)</span>を<span class="math inline">\(x\)</span>の係数・傾き</li>
</ul></li>
<li>単回帰モデルを使うことで..
<ul>
<li>説明変数と従属変数の関係の考察</li>
<li>従属変数の予測</li>
</ul></li>
</ul>
</div>
<div id="分散分析モデルダミー変数を利用するモデル" class="section level2">
<h2>6. 分散分析モデル：ダミー変数を利用するモデル</h2>
<ul>
<li>説明変数が質的変数のとき
<ul>
<li>ダミー変数を使う必要性
<ul>
<li>ダミー変数：0 / 1</li>
<li>晴れ・雨・曇りを表現する
<ul>
<li>晴れ：0/1</li>
<li>雨: 0/1</li>
</ul></li>
<li>状態-1の変数
<ul>
<li>1 0 -&gt; 晴れ</li>
<li>0 1 -&gt; 雨</li>
<li>0 0 -&gt; 曇り</li>
</ul></li>
</ul></li>
</ul></li>
<li>ビールの例
<ul>
<li>売上が天気の影響を受ける
<ul>
<li><span class="math inline">\(x_1\)</span>:晴れなら1, <span class="math inline">\(x_2\)</span>: 雨なら1, <span class="math inline">\(g()\)</span>: 恒等関数
<ul>
<li><span class="math inline">\(g(\mu_i)=\beta_0+\beta_1x_{i1}+\beta_{i2}\)</span></li>
<li>y Normal(_i, ^2)</li>
</ul></li>
<li>書き換え
<ul>
<li><span class="math inline">\(\mu_i=\beta_0+\beta_1x_{i1}+\beta_{i2}\)</span></li>
</ul></li>
<li>分散分析モデル
<ul>
<li>説明変数が質的データ</li>
<li>確率分布として正規分布</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="正規線形モデル正規分布を仮定するモデル" class="section level2">
<h2>7. 正規線形モデル：正規分布を仮定するモデル</h2>
<ul>
<li>単回帰モデルも分散分析モデルも含まれる</li>
<li>リンク関数は恒等関数</li>
<li>確率分布は正規分布</li>
<li>説明変数は量的だけ（単回帰モデル）、質的だけ（分散分析モデル）、両方とも（？）</li>
</ul>
</div>
<div id="ポアソン回帰モデル" class="section level2">
<h2>8. ポアソン回帰モデル</h2>
<ul>
<li>魚の釣果尾数のモデル化
<ul>
<li>あまり釣れないし生の数のみ、ポアソン分布に従う</li>
<li>分布のパラメータ<span class="math inline">\(\lambda\)</span>は気温と天気の影響を受ける
<ul>
<li><span class="math inline">\(p(y_i|\lambda_i)=\frac{\lambda_i^{y_i} exp(-\lambda_i)}{y_i!}\)</span></li>
<li>ここから、ちょっと馬場本の式3.10, 3.11が分かりにくく感じたので、緑本p159の説明順を参考に表現を変えます。なんでexp()なのか、logなのかの説明がなくて分からない。
<ul>
<li>パラメータ<span class="math inline">\(\lambda\)</span>が次の式に従うとする
<ul>
<li><span class="math inline">\(\lambda_i = exp(\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3)\)</span></li>
</ul></li>
<li>この式を変形すると
<ul>
<li><span class="math inline">\(log\lambda_i = \beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3\)</span></li>
<li>リンク関数: <span class="math inline">\(log\lambda_i\)</span> -&gt; 対数リンク関数</li>
<li>線形予測子：<span class="math inline">\(\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3\)</span></li>
</ul></li>
<li>馬場本P159の式3.11
<ul>
<li><span class="math inline">\(\lambda=\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3\)</span> (3.11)</li>
</ul></li>
<li>は誤解しそう</li>
<li>緑本のように
<ul>
<li><span class="math inline">\(\lambda=exp(\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3)\)</span></li>
</ul></li>
<li>とした方がいい気がする。</li>
<li>ポアソン回帰には対数リンク関数、ロジスティック回帰にはロジットリンク関数＝正準リンク関数
<ul>
<li>Rのglm()では特に指定しなけば確率分布ごとに異なる正準リンク関数が使われる</li>
<li>なぜポアソン回帰には対数リンク関数を使うのか？
<ol style="list-style-type: decimal">
<li>推定計算に都合がいいから(緑本P48): <span class="math inline">\(\lambda_i\)</span>がexp(線形予測子)になるので、負になることがない。都合がいい。</li>
<li>わかりやすいから（緑本P59あたり）：効果が掛け算になる。<span class="math inline">\(exp(\beta_0+\beta_1x_1)\)</span>は<span class="math inline">\(exp(\beta_0)\times exp(\beta_1x_1)\)</span>。複数の効果が掛け算で効いてくる方がもっともらしい。</li>
</ol></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="ロジスティック回帰モデル-二項分布を仮定するモデル" class="section level2">
<h2>9. ロジスティック回帰モデル: 二項分布を仮定するモデル</h2>
<ul>
<li>コインの裏表、種子の発芽率（発芽するかしないか）、商品の購入率（するしない）
<ul>
<li>二値確率変数</li>
<li>二項分布</li>
</ul></li>
<li>例：植物の種子の発芽率
<ul>
<li>10粒中発芽する種子数をモデル化
<ul>
<li>試行回数10の二項分布、成功確率<span class="math inline">\(p\)</span></li>
<li><span class="math inline">\(p\)</span>は日照の有無と栄養素の量に影響される</li>
<li><span class="math inline">\(y_i\)</span>: 10粒のうち発芽した数</li>
<li><span class="math inline">\(x_{i1}\)</span>: 日が当たっていれば1、当たっていなければ0のダミー変数</li>
<li><span class="math inline">\(x_{i2}\)</span>: 栄養素の量</li>
<li><span class="math inline">\(logit(p_i)=\beta_0+\beta_1x_1+\beta_2x_2\)</span></li>
<li><span class="math inline">\(y\sim Binom(10,p_i)\)</span></li>
</ul></li>
<li>ロジット関数<span class="math inline">\(logit()\)</span>
<ul>
<li><span class="math inline">\(logit(p)+log(\frac{p}{1-p})\)</span></li>
</ul></li>
<li>ロジット関数の逆関数＝ロジスティック関数
<ul>
<li><span class="math inline">\(logistic(x)=\frac{1}{1+exp(-x)}\)</span></li>
</ul></li>
</ul></li>
</ul>
<pre class="r"><code>x&lt;-seq(-10,10,0.01)
y&lt;-1/(1+exp(-x))
plot(x,y,type=&#39;l&#39;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-1-1.png" width="768" /></p>
<ul>
<li>ここで馬場本では、「二項分布のリンク関数はロジット関数なので、その逆関数であるロジスティック関数を使った回帰モデルを使う」という書き方をしてるけど、これだとやっぱりなぜリンク関数がロジット関数なのかが不明のまま。</li>
<li>緑本(P120)より
<ul>
<li><span class="math inline">\(z_i\)</span>についてのロジスティック関数<span class="math inline">\(q_i=logistic(z_i)\)</span>は上↑のような形をしているので、<span class="math inline">\(z_i=\beta_1+\beta_2x_2...\)</span>としたときの<span class="math inline">\(z_i\)</span>（つまり線形予測子）がどのような値をとっても<span class="math inline">\(0\leq q_i \leq 1\)</span>が成り立つ。だからロジスティック関数を使いたい。</li>
<li>ロジスティック関数を変形すると<span class="math inline">\(log\frac{q_i}{1-q_i}=z_i\)</span>となり、この左辺をロジット関数と呼ぶ。
<ul>
<li>だから、<span class="math inline">\(logit(p_i)=\beta_0+\beta_1x_1+\beta_2x_2\)</span>（＝線形予測子）と、ロジット関数がリンク関数となり、</li>
<li>二項分布 <span class="math inline">\(y \sim Binom(10,p_i)\)</span>のパラメータ<span class="math inline">\(p_i\)</span>が<span class="math inline">\(p_i=logistic(線形予測子)\)</span>と表せると理解すべきかと。</li>
</ul></li>
<li>このあたり、P217のポアソン回帰モデルのStanファイル、P226のロジスティック回帰モデルのStanファイル（の下の説明）ではパラメータ＝exp(線形予測子)やパラメータ＝inv_logit(線形予測子)としていて、理解しやすい。</li>
</ul></li>
</ul>
</div>
<div id="一般化線形モデルの行列表現" class="section level2">
<h2>10. 一般化線形モデルの行列表現</h2>
<ul>
<li>説明変数がj個ある、i番目のデータに関する一般化線形モデルの線形予測子は、1行j列のデータのベクトル<span class="math inline">\(x_i\)</span>とj行1列の係数のベクトル<span class="math inline">\(\boldsymbol{\beta}\)</span>の積で表すと簡潔だよっていう話</li>
<li><span class="math inline">\(\lambda=exp(x_i\beta)\)</span> # こう書ききたい。本ではここにはexp()はついていない</li>
<li><span class="math inline">\(y_i \sim Poiss(\lambda_i)\)</span> # こう書きたい。こっちにexp()がついている
<ul>
<li>ただし、データ<span class="math inline">\(x_i\)</span>はデザイン行列<span class="math inline">\(\boldsymbol{X}\)</span>の<span class="math inline">\(i\)</span>行目。</li>
</ul></li>
</ul>
</div>
<div id="補足データの表記とベクトル行列" class="section level2">
<h2>11. 補足：データの表記とベクトル・行列</h2>
<ul>
<li>データ：<span class="math inline">\(y_1, y_2, ..., y_N\)</span></li>
<li>ベクトルとスカラー
<ul>
<li>ベクトル: <span class="math inline">\(\boldsymbol{y}=[y_1\ y_2\ y_3]^T\)</span> #さすがに面倒なので列ベクトルは表示しない
<ul>
<li>ベクトルは<span class="math inline">\(\textbf{小文字太字}\)</span>で表す。Rstudioでギリシャ文字の太文字は結構めんどうで\boldsymbol{}を使うらしい</li>
<li>Tは<span class="math inline">\(transpose\)</span>転置のこと</li>
</ul></li>
<li>スカラーは量、1要素</li>
</ul></li>
<li>2つ以上の変数をまとめるときは行列とする
<ul>
<li>行列は<span class="math inline">\(\textbf{大文字太字}\)</span>で表す</li>
<li>これも面倒なので表記は省略</li>
<li>m行n列の行列という呼び方</li>
</ul></li>
</ul>
</div>
<div id="補足行列の基本的な演算" class="section level2">
<h2>12. 補足：行列の基本的な演算</h2>
<ul>
<li>行列の足し算：同じサイズの行列のみ。要素同士の足し算。</li>
<li>行列のスカラ倍：各要素<span class="math inline">\(\times\)</span>スカラ量</li>
</ul>
<pre class="r"><code>A&lt;-matrix(seq(1,6), 3, 2)
B&lt;-matrix(seq(7,12), 3, 2)
A+B</code></pre>
<pre><code>##      [,1] [,2]
## [1,]    8   14
## [2,]   10   16
## [3,]   12   18</code></pre>
<pre class="r"><code>3*A</code></pre>
<pre><code>##      [,1] [,2]
## [1,]    3   12
## [2,]    6   15
## [3,]    9   18</code></pre>
</div>
<div id="行列の掛け算" class="section level2">
<h2>13. 行列の掛け算</h2>
<ul>
<li>行列の掛け算は知ってますよね、みなさん。</li>
<li>Rでの演算子は %*%</li>
<li>*は要素同士の掛け算</li>
</ul>
<pre class="r"><code>A&lt;-matrix(seq(1,6), 3, 2)
C&lt;-matrix(seq(10,15),2,3)
A %*% C</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]   54   64   74
## [2,]   75   89  103
## [3,]   96  114  132</code></pre>
<pre class="r"><code>C %*% A</code></pre>
<pre><code>##      [,1] [,2]
## [1,]   76  184
## [2,]   82  199</code></pre>
</div>
<div id="一般化線形モデルのさまざまなトピック" class="section level2">
<h2>14. 一般化線形モデルのさまざまなトピック</h2>
<ul>
<li>交互作用：説明変数同士の影響を考えるモデル。交互作用項を作るなど。<span class="math inline">\(x_1x_2\)</span>。緑本P127</li>
<li>オフセット項：係数を1に固定することである説明変数による影響を固定する？わざ。緑本P133</li>
<li>多項ロジスティック回帰：3つ以上のカテゴリでどの比率が高くなるか、のような問題のモデル化。確率分布としてカテゴリカル分布、リンク関数としてソフトマックス関数。</li>
<li>ガンマ回帰：0以上の連続型データ。ガンマ分布、対数関数。</li>
<li>brms。</li>
</ul>
</div>
<div id="例題-伊丸岡研の希望人数に実験科目を担当していたかがどう影響するか" class="section level2">
<h2>例題: 伊丸岡研の希望人数に実験科目を担当していたかがどう影響するか</h2>
<ul>
<li>imrlab.csv
<ul>
<li>year</li>
<li>population: クラス人数</li>
<li>imrlab: 伊丸岡研希望数</li>
<li>wtnblab: 渡邊研希望数（参考）</li>
<li>basic: 基礎実験担当かどうか（ダミー変数）</li>
<li>senior: 専門実験担当かどうか（ダミー変数）</li>
</ul></li>
<li>imrlab.stan</li>
</ul>
<pre class="r"><code>DATA&lt;-read.csv(&#39;imrlab.csv&#39;)
library(rstan)
data_list&lt;-list(population=DATA[,1], applicant=DATA[,2],basic=DATA[,3],senior=DATA[,4], N=9)
mr &lt;- stan(
  file=&quot;imrlab.stan&quot;,
  data=data_list,
  iter=2000,
  warmup=1000,
  thin=1
)
print(mr,probs=c(0.025,0.5,0.975))</code></pre>
<pre><code>## Inference for Stan model: imrlab.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##               mean se_mean   sd     2.5%      50%    97.5% n_eff Rhat
## Intercept    -3.79    0.00 0.17    -4.11    -3.79    -3.46  1415    1
## b_basic       0.03    0.00 0.01     0.00     0.03     0.06  1624    1
## b_senior     -0.01    0.00 0.02    -0.04    -0.01     0.02  1567    1
## lp__      -2140.19    0.04 1.24 -2143.42 -2139.88 -2138.77  1203    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:16:41 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<pre class="r"><code>stan_trace(mr)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-4-1.png" width="768" /></p>
<pre class="r"><code>stan_dens(mr)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-4-2.png" width="768" /> # 3-2: 単回帰モデル</p>
</div>
<div id="目的と概要-1" class="section level2">
<h2>2.1 目的と概要</h2>
<ul>
<li>一般化線形モデルの初歩</li>
</ul>
</div>
<div id="分析の準備" class="section level2">
<h2>2.2 分析の準備</h2>
<ul>
<li>パッケージの読み込み(rstan, beysplot)</li>
<li>オプション指定</li>
</ul>
</div>
<div id="データ読み込みと可視化" class="section level2">
<h2>2.3 データ読み込みと可視化</h2>
<ul>
<li>ビールの売り上げ</li>
</ul>
<pre class="r"><code>rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())
library(rstan)
library(bayesplot)
bs2&lt;-read.csv(&#39;3-2-1-beer-sales-2.csv&#39;)
sample_size&lt;-nrow(bs2)
ggplot(bs2, aes(x=temperature, y=sales)) + geom_point()+labs(title=&#39;ビールの売り上げと気温の関係&#39;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-5-1.png" width="768" /></p>
</div>
<div id="モデルの構造" class="section level2">
<h2>2.4 モデルの構造</h2>
<ul>
<li>3部1章でやった形
<ul>
<li><span class="math inline">\(\mu_i = \beta_0 + \beta_1x_i\)</span></li>
<li><span class="math inline">\(y \sim Normal(\mu_i, \sigma^2)\)</span></li>
<li>気温によってビールの売り上げの平均値(<span class="math inline">\(\mu_i\)</span>)が増減する</li>
</ul></li>
<li>Stanで便利なように偏数名などを合わせる。恒等関数なので<span class="math inline">\(\mu_i\)</span>もまとめる。
<ul>
<li><span class="math inline">\(sales_i\sim Normal(Intercept+beta\times temperature_i,sigma^2)\)</span></li>
</ul></li>
<li>上の式に合わせてStanファイル実装</li>
</ul>
</div>
<div id="単回帰モデルのためのstanファイルの実装" class="section level2">
<h2>2.5 単回帰モデルのためのStanファイルの実装</h2>
<ul>
<li>chunkを使って書いてみる
<ul>
<li>var=beerでモデルのオブジェクトを作成、使用できる</li>
<li>rstan::samplingの第1引数でモデルオブジェクト、dataオプションでデータオブジェクトを指定。</li>
</ul></li>
</ul>
<pre class="stan"><code>data{
  int N;
  vector[N] sales;
  vector[N] temperature;
}
parameters{
  real Intercept;
  real beta;
  real&lt;lower=0&gt; sigma;
}
model{
  sales ~ normal(Intercept+beta * temperature, sigma);
}</code></pre>
</div>
<div id="mcmcの実行-2.7-事後分布の可視化" class="section level2">
<h2>2.6 MCMCの実行, 2.7 事後分布の可視化</h2>
<ul>
<li>ここでは前で作ったモデルオブジェクトを使う</li>
</ul>
<pre class="r"><code>library(bayesplot)
data_list&lt;-list(
  N=sample_size,
  sales=bs2$sales,
  temperature=bs2$temperature
)
mr&lt;-rstan::sampling(beer, data=data_list, seed=1)
print(mr, probs=c(0.025, 0.5, 0.975))</code></pre>
<pre><code>## Inference for Stan model: 31d2b526651ec414e920d1821baf3500.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##              mean se_mean   sd    2.5%     50%   97.5% n_eff Rhat
## Intercept   21.23    0.15 5.75   10.29   21.09   32.64  1420    1
## beta         2.45    0.01 0.28    1.90    2.46    2.98  1427    1
## sigma       17.07    0.03 1.21   14.89   16.96   19.67  1629    1
## lp__      -330.07    0.03 1.20 -333.26 -329.75 -328.73  1288    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:16:57 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<pre class="r"><code>mcs&lt;-rstan::extract(mr, permuted=FALSE)
mcmc_combo(
  mcs,
  parc=c(&quot;Intercept&quot;,&quot;beta&quot;,&quot;sigma&quot;)
)</code></pre>
<p><img src="baba3_files/figure-html/beer-1.png" width="768" /></p>
</div>
<div id="まとめ" class="section level2">
<h2>2.8 まとめ</h2>
<ol style="list-style-type: decimal">
<li>Rパッケージ読み込み</li>
<li>データ読み込み、可視化して確認</li>
<li>Stanファイルの実装</li>
<li>MCMC実行</li>
<li>収束していることの確認（Rhatなど）</li>
<li>興味あるパラメータの事後分布確認</li>
</ol>
</div>
</div>
<div id="章-一般化線形モデルの基本-1" class="section level1">
<h1>3-1章: 一般化線形モデルの基本</h1>
<div id="目的と概要-2" class="section level2">
<h2>1. 目的と概要</h2>
<ul>
<li>一般化線形モデル(GLM): 実践的モデル &amp; 複雑なモデルの部品</li>
<li>確率分布、線形予測子、リンク関数</li>
<li>リファレンス的に使える章</li>
</ul>
</div>
<div id="複雑なモデルを構築する際の手続きの標準化-1" class="section level2">
<h2>2. 複雑なモデルを構築する際の手続きの標準化</h2>
<ul>
<li>モデルをどう構築するか</li>
<li>ビールの売り上げの例
<ul>
<li><span class="math inline">\(y \sim Normal(\mu,\sigma^2)\)</span></li>
<li>これを複雑にしようとしたとき、“勝手に”やるばかりだと非効率かも</li>
<li>「モデルの方」「フレームワーク」</li>
</ul></li>
<li>一般化線形モデルにおけるモデルの変更手続き
<ol style="list-style-type: decimal">
<li>確率分布を変える</li>
<li>線形予測子を変える</li>
<li>リンク関数を変える</li>
</ol></li>
</ul>
</div>
<div id="確率分布線形予測子リンク関数-1" class="section level2">
<h2>3. 確率分布・線形予測子・リンク関数</h2>
<ul>
<li>確率分布
<ul>
<li>観測データを生む確率的過程を表現するためのもの。データに合わせて変える。
<ul>
<li>ビールなら正規分布</li>
<li>小動物の数ならポアソン分布</li>
<li>購入比率なら二項分布</li>
</ul></li>
</ul></li>
<li>変数
<ul>
<li>応答変数・従属変数</li>
<li>説明変数</li>
</ul></li>
<li>線形予測子
<ul>
<li>説明変数の線型結合</li>
</ul></li>
<li>リンク関数
<ul>
<li>応答変数と線形予測子を関係付けること</li>
</ul></li>
</ul>
</div>
<div id="一般化線形モデルの例-説明変数が無く正規分布を仮定するモデル-1" class="section level2">
<h2>4. 一般化線形モデルの例: 説明変数が無く、正規分布を仮定するモデル</h2>
<ul>
<li>ビール売り上げの例
<ul>
<li>凡例
<ul>
<li><span class="math inline">\(y_i\)</span>:売り上げデータ</li>
<li><span class="math inline">\(\mu_i\)</span>: <span class="math inline">\(y_i\)</span>の期待値</li>
<li><span class="math inline">\(_i\)</span>: 何番目のデータか</li>
<li><span class="math inline">\(g\)</span>: 恒等関数（<span class="math inline">\(g(y)=y\)</span>となる関数=何も起きない関数）</li>
</ul></li>
<li>一般化線形モデル
<ul>
<li><span class="math inline">\(g(\mu_i)=\beta_0\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu, \sigma^2)\)</span></li>
<li><span class="math inline">\(\beta_0\)</span>が線形予測子、恒等関数<span class="math inline">\(g()\)</span>がリンク関数</li>
</ul></li>
<li>書き換え
<ul>
<li><span class="math inline">\(\mu_i=\beta_0\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu, \sigma^2)\)</span></li>
</ul></li>
<li>従属変数の平均値<span class="math inline">\(\mu_i\)</span>が値<span class="math inline">\(\beta_0\)</span>をとることを想定したモデル</li>
</ul></li>
</ul>
</div>
<div id="単回帰モデル-説明変数が1つだけあり正規分布を仮定するモデル-1" class="section level2">
<h2>5. 単回帰モデル: 説明変数が1つだけあり、正規分布を仮定するモデル</h2>
<ul>
<li>ビールの売り上げが気温<span class="math inline">\(x\)</span>によって変化するというモデル
<ul>
<li><span class="math inline">\(g(\mu_i)=\beta_0+\beta_1x_i\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu_i, \sigma^2)\)</span></li>
<li><span class="math inline">\(\beta_0+\beta_1x_i\)</span>が線形予測子、恒等関数<span class="math inline">\(g()\)</span>がリンク関数</li>
</ul></li>
<li>書き換え
<ul>
<li><span class="math inline">\(\mu_i = \beta_0 + \beta_1x_i\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu_i, \sigma^2)\)</span></li>
</ul></li>
<li>気温<span class="math inline">\(x\)</span>が1変化すると<span class="math inline">\(\beta_1\)</span>増減する</li>
<li>単回帰モデル
<ul>
<li><span class="math inline">\(\beta_0\)</span>を切片</li>
<li><span class="math inline">\(\beta_1\)</span>を<span class="math inline">\(x\)</span>の係数・傾き</li>
</ul></li>
<li>単回帰モデルを使うことで..
<ul>
<li>説明変数と従属変数の関係の考察</li>
<li>従属変数の予測</li>
</ul></li>
</ul>
</div>
<div id="分散分析モデルダミー変数を利用するモデル-1" class="section level2">
<h2>6. 分散分析モデル：ダミー変数を利用するモデル</h2>
<ul>
<li>説明変数が質的変数のとき
<ul>
<li>ダミー変数を使う必要性
<ul>
<li>ダミー変数：0 / 1</li>
<li>晴れ・雨・曇りを表現する
<ul>
<li>晴れ：0/1</li>
<li>雨: 0/1</li>
</ul></li>
<li>状態-1の変数
<ul>
<li>1 0 -&gt; 晴れ</li>
<li>0 1 -&gt; 雨</li>
<li>0 0 -&gt; 曇り</li>
</ul></li>
</ul></li>
</ul></li>
<li>ビールの例
<ul>
<li>売上が天気の影響を受ける
<ul>
<li><span class="math inline">\(x_1\)</span>:晴れなら1, <span class="math inline">\(x_2\)</span>: 雨なら1, <span class="math inline">\(g()\)</span>: 恒等関数
<ul>
<li><span class="math inline">\(g(\mu_i)=\beta_0+\beta_1x_{i1}+\beta_{i2}\)</span></li>
<li>y Normal(_i, ^2)</li>
</ul></li>
<li>書き換え
<ul>
<li><span class="math inline">\(\mu_i=\beta_0+\beta_1x_{i1}+\beta_{i2}\)</span></li>
</ul></li>
<li>分散分析モデル
<ul>
<li>説明変数が質的データ</li>
<li>確率分布として正規分布</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="正規線形モデル正規分布を仮定するモデル-1" class="section level2">
<h2>7. 正規線形モデル：正規分布を仮定するモデル</h2>
<ul>
<li>単回帰モデルも分散分析モデルも含まれる</li>
<li>リンク関数は恒等関数</li>
<li>確率分布は正規分布</li>
<li>説明変数は量的だけ（単回帰モデル）、質的だけ（分散分析モデル）、両方とも（？）</li>
</ul>
</div>
<div id="ポアソン回帰モデル-1" class="section level2">
<h2>8. ポアソン回帰モデル</h2>
<ul>
<li>魚の釣果尾数のモデル化
<ul>
<li>あまり釣れないし生の数のみ、ポアソン分布に従う</li>
<li>分布のパラメータ<span class="math inline">\(\lambda\)</span>は気温と天気の影響を受ける
<ul>
<li><span class="math inline">\(p(y_i|\lambda_i)=\frac{\lambda_i^{y_i} exp(-\lambda_i)}{y_i!}\)</span></li>
<li>ここから、ちょっと馬場本の式3.10, 3.11が分かりにくく感じたので、緑本p159の説明順を参考に表現を変えます。なんでexp()なのか、logなのかの説明がなくて分からない。
<ul>
<li>パラメータ<span class="math inline">\(\lambda\)</span>が次の式に従うとする
<ul>
<li><span class="math inline">\(\lambda_i = exp(\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3)\)</span></li>
</ul></li>
<li>この式を変形すると
<ul>
<li><span class="math inline">\(log\lambda_i = \beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3\)</span></li>
<li>リンク関数: <span class="math inline">\(log\lambda_i\)</span> -&gt; 対数リンク関数</li>
<li>線形予測子：<span class="math inline">\(\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3\)</span></li>
</ul></li>
<li>馬場本P159の式3.11
<ul>
<li><span class="math inline">\(\lambda=\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3\)</span> (3.11)</li>
</ul></li>
<li>は誤解しそう</li>
<li>緑本のように
<ul>
<li><span class="math inline">\(\lambda=exp(\beta_0+\beta_1x_1+\beta_2x_2+\beta_3x_3)\)</span></li>
</ul></li>
<li>とした方がいい気がする。</li>
<li>ポアソン回帰には対数リンク関数、ロジスティック回帰にはロジットリンク関数＝正準リンク関数
<ul>
<li>Rのglm()では特に指定しなけば確率分布ごとに異なる正準リンク関数が使われる</li>
<li>なぜポアソン回帰には対数リンク関数を使うのか？
<ol style="list-style-type: decimal">
<li>推定計算に都合がいいから(緑本P48): <span class="math inline">\(\lambda_i\)</span>がexp(線形予測子)になるので、負になることがない。都合がいい。</li>
<li>わかりやすいから（緑本P59あたり）：効果が掛け算になる。<span class="math inline">\(exp(\beta_0+\beta_1x_1)\)</span>は<span class="math inline">\(exp(\beta_0)\times exp(\beta_1x_1)\)</span>。複数の効果が掛け算で効いてくる方がもっともらしい。</li>
</ol></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="ロジスティック回帰モデル-二項分布を仮定するモデル-1" class="section level2">
<h2>9. ロジスティック回帰モデル: 二項分布を仮定するモデル</h2>
<ul>
<li>コインの裏表、種子の発芽率（発芽するかしないか）、商品の購入率（するしない）
<ul>
<li>二値確率変数</li>
<li>二項分布</li>
</ul></li>
<li>例：植物の種子の発芽率
<ul>
<li>10粒中発芽する種子数をモデル化
<ul>
<li>試行回数10の二項分布、成功確率<span class="math inline">\(p\)</span></li>
<li><span class="math inline">\(p\)</span>は日照の有無と栄養素の量に影響される</li>
<li><span class="math inline">\(y_i\)</span>: 10粒のうち発芽した数</li>
<li><span class="math inline">\(x_{i1}\)</span>: 日が当たっていれば1、当たっていなければ0のダミー変数</li>
<li><span class="math inline">\(x_{i2}\)</span>: 栄養素の量</li>
<li><span class="math inline">\(logit(p_i)=\beta_0+\beta_1x_1+\beta_2x_2\)</span></li>
<li><span class="math inline">\(y\sim Binom(10,p_i)\)</span></li>
</ul></li>
<li>ロジット関数<span class="math inline">\(logit()\)</span>
<ul>
<li><span class="math inline">\(logit(p)+log(\frac{p}{1-p})\)</span></li>
</ul></li>
<li>ロジット関数の逆関数＝ロジスティック関数
<ul>
<li><span class="math inline">\(logistic(x)=\frac{1}{1+exp(-x)}\)</span></li>
</ul></li>
</ul></li>
</ul>
<pre class="r"><code>x&lt;-seq(-10,10,0.01)
y&lt;-1/(1+exp(-x))
plot(x,y,type=&#39;l&#39;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
</div>
</div>
<div id="章-単回帰モデル" class="section level1">
<h1>3-2章: 単回帰モデル</h1>
<div id="分析の準備---8.-まとめ" class="section level2">
<h2>2. 分析の準備 - 8. まとめ</h2>
<ul>
<li>beerと気温の例の実施例</li>
</ul>
</div>
</div>
<div id="章-モデルを用いた予測" class="section level1">
<h1>3-3章: モデルを用いた予測</h1>
<div id="分析の準備-1" class="section level2">
<h2>2. 分析の準備</h2>
</div>
<div id="単回帰モデルにおける予測の考え方" class="section level2">
<h2>3. 単回帰モデルにおける予測の考え方</h2>
<ul>
<li>モデル: <span class="math inline">\(sales_i \sim Normal(Intercept + beta \times temperature_i, sigma^2)\)</span></li>
<li>モデル推定で切片とベータが分かっていれば、ある気温の売り上げを計算できる
<ul>
<li>ただし、その切片は単に「分布の代表値」</li>
</ul></li>
</ul>
</div>
<div id="予測のためのデータの整理" class="section level2">
<h2>4. 予測のためのデータの整理</h2>
<ul>
<li>予測したい気温のリストを作成</li>
</ul>
</div>
<div id="予測のためのstanファイルの修正" class="section level2">
<h2>5. 予測のためのStanファイルの修正</h2>
<ul>
<li>generated quantitiesブロックを作成
<ul>
<li>事後予測分布を取得</li>
</ul></li>
</ul>
</div>
<div id="mcmcの実行" class="section level2">
<h2>6. MCMCの実行</h2>
<ul>
<li>モデル推定と事後予測分布が得られる</li>
</ul>
</div>
<div id="予測分布の可視化" class="section level2">
<h2>7. 予測分布の可視化</h2>
<ul>
<li>beyesplotパッケージなどで図示
<ul>
<li>正規表現を使うための引数: regex_pars</li>
</ul></li>
<li>95%予測区間</li>
<li>予測分布</li>
</ul>
</div>
</div>
<div id="章-デザイン行列を用いた一般化線形モデルの推定" class="section level1">
<h1>3-4章: デザイン行列を用いた一般化線形モデルの推定</h1>
<div id="分析の準備-2" class="section level2">
<h2>2. 分析の準備</h2>
<ul>
<li>beerの例</li>
</ul>
<pre class="r"><code>library(rstan)
library(bayesplot)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

beerf&lt;-read.csv(&quot;3-2-1-beer-sales-2.csv&quot;)
sample_size &lt;- nrow(beerf)</code></pre>
</div>
<div id="デザイン行列を使ったモデルの数学的な表現" class="section level2">
<h2>3. デザイン行列を使ったモデルの数学的な表現</h2>
<ul>
<li>ビールの売り上げ
<ul>
<li><span class="math inline">\(\mu_i = \beta_0 + \beta_1x_i\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu_i, \sigma^2)\)</span></li>
</ul></li>
<li>ここで期待値のベクトル<span class="math inline">\(\boldsymbol{\mu}\)</span>, デザイン行列<span class="math inline">\(\boldsymbol{X}\)</span>とすると、
<ul>
<li><span class="math inline">\(\boldsymbol{\mu} = \boldsymbol{X\beta}\)</span></li>
</ul></li>
</ul>
</div>
<div id="formula構文を用いたデザイン行列の作成" class="section level2">
<h2>4. formula構文を用いたデザイン行列の作成</h2>
<ul>
<li>formula記法</li>
<li><span class="math inline">\(formula(応答変数 \sim 説明変数)\)</span></li>
<li>model.matrix関数</li>
</ul>
<pre class="r"><code>flm &lt;- formula(sales ~ temperature)
X &lt;- model.matrix(flm, beerf)</code></pre>
</div>
<div id="デザイン行列を使うためのstanファイルの設定" class="section level2">
<h2>5. デザイン行列を使うためのStanファイルの設定</h2>
<ul>
<li>stanファイルを修正する</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K;
  vector[N] Y;
  matrix[N, K] X;
}

parameters{
  vector[K] b;
  real&lt;lower = 0&gt; sigma;
}

transformed parameters{
  vector[N] mu = X * b;
}

model{
  Y ~ normal(mu, sigma);
}</code></pre>
</div>
<div id="mcmcの実行-1" class="section level2">
<h2>6. MCMCの実行</h2>
<pre class="r"><code>N &lt;- nrow(beerf)
K &lt;- 2
Y &lt;- beerf$sales
dl &lt;- list(N = N, K = K, Y = Y, X = X)

res&lt;-rstan::sampling(beer_design, data=dl, seed=1)
print(res, probs = c(0.025, 0.5, 0.975))</code></pre>
<pre><code>## Inference for Stan model: 61434762f6b0fcc57b85a34f69371a85.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##            mean se_mean   sd    2.5%     50%   97.5% n_eff Rhat
## b[1]      20.78    0.17 5.89    9.31   20.74   32.27  1247    1
## b[2]       2.48    0.01 0.29    1.91    2.47    3.04  1245    1
## sigma     17.06    0.03 1.25   14.89   16.97   19.67  1514    1
## mu[1]     54.71    0.06 2.42   49.93   54.73   59.44  1670    1
## mu[2]     80.22    0.04 2.13   76.14   80.18   84.42  2926    1
## mu[3]     74.03    0.03 1.80   70.57   73.98   77.47  4418    1
## mu[4]     53.96    0.06 2.48   49.08   54.00   58.82  1632    1
## mu[5]     92.35    0.07 3.16   86.30   92.28   98.66  1805    1
## mu[6]     92.35    0.07 3.16   86.30   92.28   98.66  1805    1
##  [ reached getOption(&quot;max.print&quot;) -- 95 行を無視しました ] 
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:17:15 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="brmsの使い方" class="section level1">
<h1>3-5. brmsの使い方</h1>
<div id="brmsとは" class="section level2">
<h2>2. brmsとは</h2>
<ul>
<li>Stanを使ったベイジアン回帰モデル</li>
</ul>
</div>
<div id="本書での実装の方針" class="section level2">
<h2>3. 本書での実装の方針</h2>
</div>
<div id="分析の準備-3" class="section level2">
<h2>4. 分析の準備</h2>
<ul>
<li>brmsパッケージが必要</li>
</ul>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

beersf&lt;-read.csv(&#39;3-2-1-beer-sales-2.csv&#39;)</code></pre>
</div>
<div id="brmsによる単回帰モデルの推定" class="section level2">
<h2>5. brmsによる単回帰モデルの推定</h2>
<ul>
<li>Stanファイル不要</li>
<li>指定が必要なもの
<ul>
<li>線形予測子</li>
<li>確率分布</li>
<li>リンク関数</li>
</ul></li>
<li>結果
<ul>
<li>切片、係数</li>
<li>Estimate: 点推定値</li>
</ul></li>
<li>as.mcmc(): MCMCサンプル取得</li>
<li>plot(): 事後分布、トレースプロットの図示</li>
</ul>
<pre class="r"><code>lm_brms&lt;-brm(
  formula = sales ~ temperature,
  family = gaussian(link=&#39;identity&#39;),
  data = beersf,
  seed = 1
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>print(lm_brms)</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: sales ~ temperature 
##    Data: beersf (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept      21.24      6.05     9.47    33.16 1.00     3658     2784
## temperature     2.46      0.29     1.89     3.01 1.00     3850     3069
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma    17.02      1.24    14.82    19.63 1.00     4060     3003
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code># as.mcmc(lm_brms, combine_chains = TRUE)
plot(lm_brms)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-12-1.png" width="768" /></p>
</div>
<div id="brmsの基本的な使い方" class="section level2">
<h2>6. brmsの基本的な使い方</h2>
<ul>
<li>bf(): formulaをbrmの外で定義可能
<ul>
<li>lm_formula &lt;- bf(sales ~ temperature) など</li>
</ul></li>
<li>familyに使える分布
<ul>
<li>gaussian()</li>
<li>binomial()</li>
<li>poisson()</li>
<li>などなど</li>
<li>Rで関数実行すると標準で指定されているlink関数が表示される</li>
</ul></li>
</ul>
</div>
<div id="事前分布の変更" class="section level2">
<h2>7. 事前分布の変更</h2>
<ul>
<li>prior_summary(): 事前分布一覧の表示</li>
</ul>
<pre class="r"><code>prior_summary(lm_brms)</code></pre>
<pre><code>##                   prior     class        coef group resp dpar nlpar bound
##                  (flat)         b                                        
##                  (flat)         b temperature                            
##  student_t(3, 71.5, 20) Intercept                                        
##     student_t(3, 0, 20)     sigma                                        
##        source
##       default
##  (vectorized)
##       default
##       default</code></pre>
<ul>
<li>一覧
<ul>
<li>flatは一様分布?</li>
<li>切片には自由度3、中心位置71.5、分布の裾の広さ20のstudent t分布を使ってるということ</li>
<li>sigmaの分布は中心0、広さ20</li>
</ul></li>
<li>事前分布を変更したい場合</li>
</ul>
<pre class="r"><code>lm_brms2 &lt;- brm(
  formula=sales~temperature,
  family = gaussian(),
  data = beersf,
  seed = 1,
  prior=c(set_prior(&quot;&quot;,class=&quot;Intercept&quot;),
          set_prior(&quot;&quot;,class=&quot;sigma&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>prior_summary(lm_brms2)</code></pre>
<pre><code>##   prior     class        coef group resp dpar nlpar bound       source
##  (flat)         b                                              default
##  (flat)         b temperature                             (vectorized)
##  (flat) Intercept                                                 user
##  (flat)     sigma                                                 user</code></pre>
<ul>
<li>stanコードの抽出
<ul>
<li>stancode(lm_brms2)</li>
</ul></li>
<li>データの抽出
<ul>
<li>standata(lm_brms2)</li>
</ul></li>
</ul>
</div>
<div id="補足brmsの基本的な仕組み" class="section level2">
<h2>8. 補足：brmsの基本的な仕組み</h2>
<ul>
<li>make_stancode関数で Stanコードを生成</li>
<li>make_standata関数でデータを生成</li>
</ul>
</div>
<div id="補足make_stancode関数によるstanコードの作成" class="section level2">
<h2>9. 補足：make_stancode関数によるStanコードの作成</h2>
<ul>
<li>データ、パラメータはベクトル化</li>
<li>modelはサンプリング文ではなく、対数密度加算文として記述される
<ul>
<li>なぜ対数密度加算文か
<ul>
<li>2部6章ではサンプリング文を基本として、対数密度加算文でも書けると説明</li>
<li>実際には、Stan内部では対数密度の加算をしていて、それを理解しやすいようにサンプリング文でも書けるということらしい（<a href="https://github.com/stan-ja/stan-ja/blob/master/part02/chap05/chap05.md#53-対数密度加算文">Stanマニュアル: 対数密度加算文</a>）。</li>
<li>対数密度加算文で使う target の意味が良く分からなかったけど、これは変数ではなく、Stanであらかじめ決められた対数密度を示すものらしい。以前はlp__(log probability)という変数だった?</li>
</ul></li>
</ul></li>
<li>generated quantitiesでは標準化をもとに戻す処理。標準化後の切片ー平均*効果</li>
</ul>
</div>
<div id="補足make_standata関数によるstanに渡すデータの作成" class="section level2">
<h2>10. 補足：make_standata関数による、Stanに渡すデータの作成</h2>
</div>
<div id="補足rstanでbrmsの結果を再現する" class="section level2">
<h2>11. 補足：rstanでbrmsの結果を再現する</h2>
</div>
<div id="brmsによる事後分布の可視化" class="section level2">
<h2>12. brmsによる事後分布の可視化</h2>
<ul>
<li>パラメータで正規表現使用可能
<ul>
<li>^ は文字列の先頭を示す正規表現</li>
<li>stanplot()関数</li>
</ul></li>
</ul>
</div>
<div id="brmsによる予測" class="section level2">
<h2>13. brmsによる予測</h2>
<ul>
<li>予測</li>
</ul>
<pre class="r"><code>new_data &lt;- data.frame(temperature = 20)
fitted(lm_brms, new_data)</code></pre>
<pre><code>##      Estimate Est.Error     Q2.5    Q97.5
## [1,]  70.3778  1.708378 66.89337 73.72776</code></pre>
<pre class="r"><code>set.seed(1)
predict(lm_brms, new_data)</code></pre>
<pre><code>##      Estimate Est.Error     Q2.5    Q97.5
## [1,] 70.41915  17.71716 35.03059 105.2578</code></pre>
<ul>
<li>fitted(事後平均値とベイズ信用区間)、predict(事後平均値とベイズ予測区間)の違い
<ul>
<li>fitted/信用区間：推定されたパラメータの範囲</li>
<li>predict/予測区間：推定されたモデルから得られるデータの範囲（サンプリング誤差も含む）</li>
</ul></li>
</ul>
</div>
<div id="補足predict関数を使わない予測の実装" class="section level2">
<h2>14. 補足：predict関数を使わない予測の実装</h2>
<ul>
<li>手順の確認のための実装</li>
<li>fittedとpredictの違いも分かりやすい
<ol style="list-style-type: decimal">
<li>as.mcmc()でMCMCサンプル取り出し</li>
<li>取り出したMCMCサンプルの切片と傾きを使って予測値を算出し、モデルを作る</li>
<li>作成したモデルを使って予測値の生成</li>
</ol></li>
</ul>
</div>
<div id="回帰直線の図示" class="section level2">
<h2>15. 回帰直線の図示</h2>
<ul>
<li>可視化のため</li>
<li>marginal_effects()関数で作成可能</li>
<li>回帰直線＋信用区間<br />
</li>
<li>回帰直線＋予測区間</li>
<li>引数effectを追加することで、特定の説明変数に注目した図示が可能</li>
</ul>
</div>
<div id="反応時間練習問題" class="section level2">
<h2>反応時間練習問題</h2>
<pre class="r"><code>library(brms)
dat_mr=read.table(&quot;mentalrotation.csv&quot;,header = TRUE,sep = &quot;,&quot;)
sort(unique(dat_mr$angle))</code></pre>
<pre><code>## [1]   0  40  80 120 160</code></pre>
<pre class="r"><code>dat_mr$angle=dat_mr$angle/180*pi
hist(dat_mr$rt,xlim=c(0,5),breaks=20)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-17-1.png" width="768" /></p>
<pre class="r"><code>formula_mr &lt;- bf(rt ~ angle)
#fit &lt;- brm(
#  formula = formula_mr,
#  family = exgaussian(link=&quot;identity&quot;, link_sigma = &quot;log&quot;, link_beta = &quot;log&quot;),
#  data = dat_mr, 
#  seed = 1) 
fit &lt;- brm(
  formula = formula_mr,
  family = shifted_lognormal(link=&quot;identity&quot;, link_sigma = &quot;log&quot;),
  data = dat_mr, 
  seed = 1) </code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>set.seed(1)
eff_predict_mr &lt;- conditional_effects(fit, method=&quot;predict&quot;)
plot(eff_predict_mr, points = TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-17-2.png" width="768" /></p>
<pre class="r"><code>fit</code></pre>
<pre><code>##  Family: shifted_lognormal 
##   Links: mu = identity; sigma = identity; ndt = identity 
## Formula: rt ~ angle 
##    Data: dat_mr (Number of observations: 3202) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.90      0.03    -0.96    -0.83 1.00     1104     1406
## angle         0.40      0.01     0.38     0.43 1.00     1556     1657
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.55      0.01     0.53     0.57 1.00     1169     1489
## ndt       0.34      0.01     0.32     0.36 1.00     1069     1420
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<div id="章-ダミー変数と分散分析モデル" class="section level1">
<h1>3-6章: ダミー変数と分散分析モデル</h1>
<div id="モデルの構造-1" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>質的説明変数：ダミー変数</li>
<li>例
<ul>
<li>ビールの売り上げ<span class="math inline">\(y_i\)</span></li>
<li>天気<span class="math inline">\(x_{i1}\)</span>, <span class="math inline">\(x_{i2}\)</span></li>
<li>売り上げは正規分布(<span class="math inline">\(\mu_i\)</span>,<span class="math inline">\(\sigma\)</span>)に従う</li>
<li><span class="math inline">\(\mu_i=\beta_0+\beta_1x_{i1}+\beta_2x_{i2}\)</span></li>
<li><span class="math inline">\(y_i \sim Normal(\mu_i, \sigma^2)\)</span></li>
</ul></li>
</ul>
<pre class="r"><code>library(ggplot2)
sales_w&lt;-read.csv(&#39;3-6-1-beer-sales-3.csv&#39;)
ggplot(data=sales_w, mapping=aes(x=weather, y=sales))+geom_violin()+geom_point(aes(color=weather))+labs(title=&#39;beer sales ans weather&#39;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-18-1.png" width="768" /></p>
</div>
<div id="brmsによる分散分析モデルの推定" class="section level2">
<h2>5. brmsによる分散分析モデルの推定</h2>
<pre class="r"><code>library(brms)
anova_brms&lt;-brm(
  formula=sales~weather,
  family=gaussian(link=&quot;log&quot;),
  data=sales_w,
  seed=1,
  prior=c(set_prior(&quot;&quot;, class=&quot;Intercept&quot;),
          set_prior(&quot;&quot;, class=&quot;sigma&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>anova_brms</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = log; sigma = identity 
## Formula: sales ~ weather 
##    Data: sales_w (Number of observations: 150) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept        4.14      0.04     4.06     4.21 1.00     3100     2245
## weatherrainy    -0.01      0.05    -0.11     0.10 1.00     3159     2479
## weathersunny     0.28      0.05     0.18     0.37 1.00     3344     2411
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma    16.94      1.04    15.09    19.18 1.00     3877     2704
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>eff&lt;-conditional_effects(anova_brms)
plot(eff, points=FALSE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-19-1.png" width="768" /></p>
</div>
<div id="補足-分散分析モデルのデザイン行列" class="section level2">
<h2>6. 補足: 分散分析モデルのデザイン行列</h2>
<pre class="r"><code>formula_anova&lt;-formula(sales~weather)
design_mat&lt;-model.matrix(formula_anova, sales_w)

data_list&lt;-list(
  N=nrow(sales_w),
  K=3,
  Y=sales_w$sales,
  X=design_mat
)

library(rstan)
anova_stan&lt;-rstan::sampling(beer_design,
                            data=data_list,
                            seed=1
)</code></pre>
</div>
</div>
<div id="正規線形モデル" class="section level1">
<h1>3-7: 正規線形モデル</h1>
<div id="モデルの構造-2" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>正規線形モデル：リンク関数が恒等関数であるモデルの総称</li>
<li>ここで使うモデル
<ul>
<li><span class="math inline">\(売り上げの平均値=晴れ＋雨＋気温\)</span></li>
<li><span class="math inline">\(\mu_i=\beta_0+\beta_1x_{i1}+\beta_2x_{i2}+\beta_3x_{i3}\)</span></li>
<li><span class="math inline">\(y_i\sim Normal(\mu_i, \sigma^2)\)</span></li>
</ul></li>
</ul>
</div>
<div id="分析の準備-4" class="section level2">
<h2>3. 分析の準備</h2>
<ul>
<li>いつもの</li>
</ul>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())</code></pre>
</div>
<div id="データの読み込み" class="section level2">
<h2>4. データの読み込み</h2>
<ul>
<li>天気と気温が売り上げの平均値に影響するというモデルのためのデータ</li>
</ul>
<pre class="r"><code>data37&lt;-read.csv(&#39;3-7-1-beer-sales-4.csv&#39;)
summary(data37)</code></pre>
<pre><code>##      sales          weather           temperature   
##  Min.   : 26.06   Length:150         Min.   :10.10  
##  1st Qu.: 61.19   Class :character   1st Qu.:14.82  
##  Median : 80.55   Mode  :character   Median :19.00  
##  Mean   : 79.58                      Mean   :19.91  
##  3rd Qu.: 96.11                      3rd Qu.:25.35  
##  Max.   :137.57                      Max.   :29.80</code></pre>
<pre class="r"><code>ggplot(data=data37,
       mapping=aes(x=temperature, y=sales))+
      geom_point(aes(color=weather))+labs(title=&quot;effect of temperature and weather on beer sales&quot;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-22-1.png" width="768" /></p>
</div>
<div id="brmsによる正規線形モデルの推定" class="section level2">
<h2>5. brmsによる正規線形モデルの推定</h2>
<pre class="r"><code>brms37&lt;-brm(
  formula = sales ~ weather + temperature,
  family = gaussian(),
  data = data37,
  seed = 1,
  prior = c(set_prior(&quot;&quot;, class=&quot;Intercept&quot;),
            set_prior(&quot;&quot;, class=&quot;sigma&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brms37</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: sales ~ weather + temperature 
##    Data: data37 (Number of observations: 150) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept       20.22      5.00    10.25    30.16 1.00     4702     2446
## weatherrainy    -3.51      3.16    -9.84     2.81 1.00     4491     3314
## weathersunny    29.45      3.19    23.29    35.60 1.00     4266     3036
## temperature      2.55      0.22     2.10     2.98 1.00     4292     2734
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma    16.07      0.96    14.29    18.08 1.00     4621     2692
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>eff&lt;-conditional_effects(brms37, effect=&quot;temperature:weather&quot;)
plot(eff, points=TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-23-1.png" width="768" /></p>
<pre class="r"><code>eff_pre&lt;-conditional_effects(brms37, effect=&quot;temperature:weather&quot;, method=&quot;predict&quot;)
plot(eff_pre, points=TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-23-2.png" width="768" /></p>
<ul>
<li>weathersunnyの推定値が29.45（信用区間は0をまたがない）: 晴れの日には＋29万円の効果</li>
<li>temperatureの推定値が2.55（信用区間は0をまたがない）：気温1℃で2.55万円増加</li>
</ul>
</div>
<div id="補足正規線形モデルのデザイン行列stanによる解析" class="section level2">
<h2>6. 補足：正規線形モデルのデザイン行列（Stanによる解析）</h2>
<ul>
<li>まずはbrmsによる解析からstanファイルを生成してみる</li>
</ul>
<pre class="r"><code>stancode(brms37)</code></pre>
<pre><code>## // generated with brms 2.16.3
## functions {
## }
## data {
##   int&lt;lower=1&gt; N;  // total number of observations
##   vector[N] Y;  // response variable
##   int&lt;lower=1&gt; K;  // number of population-level effects
##   matrix[N, K] X;  // population-level design matrix
##   int prior_only;  // should the likelihood be ignored?
## }
## transformed data {
##   int Kc = K - 1;
##   matrix[N, Kc] Xc;  // centered version of X without an intercept
##   vector[Kc] means_X;  // column means of X before centering
##   for (i in 2:K) {
##     means_X[i - 1] = mean(X[, i]);
##     Xc[, i - 1] = X[, i] - means_X[i - 1];
##   }
## }
## parameters {
##   vector[Kc] b;  // population-level effects
##   real Intercept;  // temporary intercept for centered predictors
##   real&lt;lower=0&gt; sigma;  // dispersion parameter
## }
## transformed parameters {
## }
## model {
##   // likelihood including constants
##   if (!prior_only) {
##     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);
##   }
##   // priors including constants
## }
## generated quantities {
##   // actual population-level intercept
##   real b_Intercept = Intercept - dot_product(means_X, b);
## }</code></pre>
<ul>
<li>続いて3部4章のStanファイル</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K; //デザイン行列列数
  vector[N] Y; //売り上げを代入するベクトル
  matrix[N, K] X; //デザイン行列
}
parameters{
  vector[K] b;
  real&lt;lower=0&gt; sigma;
}
model{
  vector[N] mu = X * b;
  Y ~ normal(mu, sigma);
}</code></pre>
<ul>
<li>Stanコードを実行</li>
</ul>
<pre class="r"><code># デザイン行列
formula37&lt;-formula(sales ~ weather + temperature)
mtx37&lt;-model.matrix(formula37, data37) ## data37はcsvファイルを読み込んだデータ

standata37&lt;-list(
  N=nrow(data37),
  K=4, # 切片、天気雨、天気晴れ、気温
  Y=data37$sales,
  X=mtx37
)

library(rstan)
stanres37&lt;-rstan::sampling(stan37,
                           data=standata37,
                           seed=1)
stanres37</code></pre>
<pre><code>## Inference for Stan model: 18eae6a6d0f7ded641090096a30443de.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##          mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## b[1]    20.12    0.11 5.01   10.21   16.84   20.08   23.38   30.08  1947    1
## b[2]    -3.53    0.06 3.20   -9.80   -5.64   -3.53   -1.41    2.96  2514    1
## b[3]    29.46    0.06 3.19   23.33   27.29   29.39   31.61   35.94  2432    1
## b[4]     2.55    0.00 0.22    2.12    2.41    2.55    2.69    2.99  2215    1
## sigma   16.05    0.02 0.96   14.36   15.39   15.99   16.65   18.09  2741    1
## lp__  -487.95    0.04 1.65 -492.03 -488.75 -487.59 -486.75 -485.82  1515    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:18:19 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<ul>
<li>brmsとほぼ同じ結果になった</li>
</ul>
</div>
</div>
<div id="ポアソン回帰モデル-2" class="section level1">
<h1>3-8: ポアソン回帰モデル</h1>
<div id="モデルの構造-3" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>ポアソン分布：離散型で0以上の整数データのとき
<ul>
<li>パラメータ<span class="math inline">\(\lambda\)</span></li>
<li>期待値も分散も<span class="math inline">\(\lambda\)</span></li>
<li>リンク関数は<span class="math inline">\(log\)</span></li>
</ul></li>
<li>ここでの例
<ul>
<li>釣り</li>
<li>釣果＝天気＋気温
<ul>
<li>ただしポアソン分布を考えるので</li>
<li><span class="math inline">\(log(\lambda) = \beta_0 + \beta_1x_1 + \beta_2x_2\)</span>
<ul>
<li><span class="math inline">\(個人的には\lambda_i = exp(\beta_0 + \beta_1x_1 + \beta_2x_2)\)</span>の方が理解しやすい（と、3-1でも書いた。緑本にはこう書いてある。）</li>
</ul></li>
<li><span class="math inline">\(y_i \sim Poiss(\lambda_i)\)</span></li>
<li>馬場本では<span class="math inline">\(log(\lambda)=\)</span>の式もあって、下の式もあるのが分かりにくい感じがする
<ul>
<li><span class="math inline">\(\lambda = \beta_0 + \beta_1x_1 + \beta_2x_2\)</span></li>
<li><span class="math inline">\(y_i \sim Poiss(exp(\lambda_i))\)</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="分析の準備-5" class="section level2">
<h2>3. 分析の準備</h2>
<ul>
<li>いつもの</li>
</ul>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())</code></pre>
</div>
<div id="データの読み込みと可視化" class="section level2">
<h2>4. データの読み込みと可視化</h2>
<pre class="r"><code>data38&lt;-read.csv(&quot;3-8-1-fish-num-1.csv&quot;)
summary(data38)</code></pre>
<pre><code>##     fish_num     weather           temperature   
##  Min.   :0.0   Length:100         Min.   : 0.20  
##  1st Qu.:0.0   Class :character   1st Qu.: 6.75  
##  Median :1.0   Mode  :character   Median :13.25  
##  Mean   :1.6                      Mean   :14.75  
##  3rd Qu.:2.0                      3rd Qu.:23.23  
##  Max.   :8.0                      Max.   :29.70</code></pre>
<pre class="r"><code>ggplot(data=data38,
       mapping=aes(x=temperature, y=fish_num))+
  geom_point(aes(color=weather))+
  labs(title=&quot;effect of temperature and weather on num of fishes&quot;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-27-1.png" width="768" /></p>
</div>
<div id="brmsによるポアソン回帰モデルの推定" class="section level2">
<h2>5. brmsによるポアソン回帰モデルの推定</h2>
<ul>
<li>正規線形モデルとほぼ同じだけど、sigmaの事前分布の指定がない（推定しないから）</li>
</ul>
<pre class="r"><code>brms38&lt;-brm(
  formula = fish_num ~ weather + temperature,
  family=poisson(),
  data=data38,
  seed=1,
  prior=c(set_prior(&quot;&quot;,class=&quot;Intercept&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brms38</code></pre>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: fish_num ~ weather + temperature 
##    Data: data38 (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept       -0.78      0.23    -1.25    -0.33 1.00     2667     2348
## weathersunny    -0.60      0.17    -0.93    -0.28 1.00     2763     2437
## temperature      0.08      0.01     0.06     0.10 1.00     2849     2663
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div id="推定されたモデルの解釈" class="section level2">
<h2>6. 推定されたモデルの解釈</h2>
<ul>
<li>weathersunnyの係数の推定値は-0.60
<ul>
<li>ただし、exp(-0.60)=0.5488</li>
<li>晴れると0.54倍になる
<ul>
<li>倍でいいの？と思ったけど、expの中の足し算は掛け算。</li>
</ul></li>
</ul></li>
<li>temperatureは0.08
<ul>
<li>exp(0.08)=1.0832</li>
<li>晴れると微妙に増える</li>
</ul></li>
<li>釣果数の期待値<span class="math inline">\(\lambda=exp(-.78-0.60 \times 晴れかどうか+0.08 \times 気温)\)</span></li>
</ul>
</div>
<div id="回帰曲線の図示" class="section level2">
<h2>7. 回帰曲線の図示</h2>
<ul>
<li>95%ベイズ信用区間つき</li>
</ul>
<pre class="r"><code>eff38&lt;-conditional_effects(brms38,
                          effects=&quot;temperature:weather&quot;) # weatherを前にすれば横軸がweatherになる
plot(eff38, points=TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-29-1.png" width="768" /></p>
<ul>
<li>予測区間
<ul>
<li>過分散となることがある
<ul>
<li>期待値と分散が一つのパラメータで決まるから、とあるけど、なぜ？</li>
<li>緑本で「過分散」を調べてみる
<ul>
<li>P149脚注: 「現実のカウントデータでは平均よりも分散の方が大きくなる場合がほとんどです。詳しくは7.6節（以下略）」</li>
<li>P165 7.6節: ここでは過分散の原因として個体差を挙げている。種子数の例を使っていて、本来正規分布する植物の大きさが観測されていないため、という理屈。緑本的にはここから一般化線形混合モデル（GLMM）を使うという流れ。</li>
<li>馬場本でも第4分階層ベイズ（一般化線形混合モデル）と進む</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<pre class="r"><code>set.seed(1)
eff_pre38&lt;-conditional_effects(brms38,
                              method=&#39;predict&#39;,
                              effects=&#39;temperature:weather&#39;,
                              probs=c(0.05, 0.995))</code></pre>
<pre><code>## Warning: Argument &#39;probs&#39; is deprecated. Please use &#39;prob&#39; instead.</code></pre>
<pre class="r"><code>plot(eff_pre38, points=TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-30-1.png" width="768" /></p>
</div>
<div id="補足ポアソン回帰モデルのためのstanファイルの実装" class="section level2">
<h2>8. 補足：ポアソン回帰モデルのためのStanファイルの実装</h2>
<ul>
<li>ここでもStanファイルから実行してみる</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int fish_num[N];
  vector[N] temp;
  vector[N] sunny;
}
parameters{
  real Intercept;
  real b_temp;
  real b_sunny;
}
model{
  vector[N] lambda=exp(Intercept + b_sunny*sunny + b_temp*temp);
  fish_num~poisson(lambda);
}</code></pre>
<ul>
<li>上のStanファイルを実行
<ul>
<li>下の計算ではデータからダミー変数を作ったけど、それをやる必要はない？</li>
</ul></li>
</ul>
<pre class="r"><code>data38&lt;-read.csv(&#39;3-8-1-fish-num-1.csv&#39;) #データ読み込み
data38$sunny&lt;-as.integer(data38$weather==&#39;sunny&#39;) # 晴れの日ダミー変数作成
standata38&lt;-list(  # Stanに渡すためにリストにまとめる
  N=nrow(data38),
  fish_num=data38$fish_num,
  temp=data38$temp,
  sunny=data38$sunny
)

res38&lt;-rstan::sampling(stan38, data=standata38, seed=1)
print(res38)</code></pre>
<pre><code>## Inference for Stan model: e329c84b9dafccadcdc4bd4254c33f37.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##             mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## Intercept  -0.81    0.01 0.25  -1.31  -0.97  -0.80  -0.64  -0.34  1114    1
## b_temp      0.08    0.00 0.01   0.06   0.08   0.08   0.09   0.10  1083    1
## b_sunny    -0.58    0.00 0.17  -0.91  -0.70  -0.58  -0.47  -0.26  1978    1
## lp__      -37.73    0.03 1.25 -40.98 -38.28 -37.41 -36.85 -36.33  1344    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:18:23 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<ul>
<li>デザイン行列バージョンも一応。</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K;
  int Y[N];
  matrix[N, K] X;
}
parameters{
  vector[K] b;
}
model{
  vector[N] lambda = X * b;
  Y ~ poisson_log(lambda);
}</code></pre>
<ul>
<li>この下で使ってるformula関数、model.matrix関数が結構謎。model.matrixは名義尺度のweatherからダミー変数weathersunnyを自動的に生成しているように見える。</li>
</ul>
<pre class="r"><code>data38&lt;-read.csv(&#39;3-8-1-fish-num-1.csv&#39;) #データ読み込み
formula38&lt;-formula(fish_num~weather+temperature)
mtx38&lt;-model.matrix(formula38, data38)
standatamtx38&lt;-list(
  N=nrow(data38),
  K=3,
  Y=data38$fish_num,
  X=mtx38
)
resmtx38&lt;-rstan::sampling(modelmtx38, data=standatamtx38, seed=1)
print(resmtx38)</code></pre>
<pre><code>## Inference for Stan model: 4c43339f9706b3c93aef14ebdf915da2.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##        mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## b[1]  -0.79    0.01 0.24  -1.28  -0.96  -0.78  -0.63  -0.36  1328    1
## b[2]  -0.59    0.00 0.16  -0.92  -0.70  -0.59  -0.48  -0.26  1751    1
## b[3]   0.08    0.00 0.01   0.06   0.08   0.08   0.09   0.10  1414    1
## lp__ -37.65    0.03 1.19 -40.79 -38.17 -37.35 -36.79 -36.32  1416    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:18:23 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="ロジスティック回帰モデル" class="section level1">
<h1>3-9. ロジスティック回帰モデル</h1>
<div id="モデルの構造-4" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>2値データ</li>
<li>種子が発芽するかしないか
<ul>
<li>発芽率<span class="math inline">\(p\)</span></li>
<li>確率分布：二項分布</li>
<li>リンク関数：ロジット関数</li>
<li><span class="math inline">\(p_i\)</span>: 発芽確率</li>
<li><span class="math inline">\(y_i\)</span>: 10粒中の発芽数</li>
<li><span class="math inline">\(x_{i1}\)</span>: 日当たり有無のダミー変数</li>
<li><span class="math inline">\(x_{i2}\)</span>: 栄養素量</li>
<li><span class="math inline">\(p_i = logostic(\beta_0+\beta_1x_{i1}+\beta_2{xi})\)</span> :パラメータ<span class="math inline">\(p\)</span>は0から1の間で変化するロジスティック関数に従う</li>
<li><span class="math inline">\(y_i\sim Binom(10, p_i)\)</span></li>
</ul></li>
</ul>
</div>
<div id="分析の準備-6" class="section level2">
<h2>3. 分析の準備</h2>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())</code></pre>
</div>
<div id="データの読み込みと可視化-1" class="section level2">
<h2>4. データの読み込みと可視化</h2>
<pre class="r"><code>dat39&lt;-read.csv(&#39;3-9-1-germination.csv&#39;)
summary(dat39)</code></pre>
<pre><code>##   germination         size       solar             nutrition   
##  Min.   : 0.00   Min.   :10   Length:100         Min.   : 1.0  
##  1st Qu.: 0.00   1st Qu.:10   Class :character   1st Qu.: 3.0  
##  Median : 1.00   Median :10   Mode  :character   Median : 5.5  
##  Mean   : 2.83   Mean   :10                      Mean   : 5.5  
##  3rd Qu.: 4.00   3rd Qu.:10                      3rd Qu.: 8.0  
##  Max.   :10.00   Max.   :10                      Max.   :10.0</code></pre>
<pre class="r"><code>ggplot(data=dat39, 
       mapping=aes(x=nutrition, y=germination, color=solar)) + geom_point() + labs(title=&#39;relation between germination and solar and nutrition&#39;)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-34-1.png" width="768" /></p>
</div>
<div id="brmsによるロジスティック回帰モデルの推定" class="section level2">
<h2>5. brmsによるロジスティック回帰モデルの推定</h2>
<pre class="r"><code>brms39&lt;-brm(
  germination | trials(size) ~ solar + nutrition,
  family = binomial(),
  data=dat39,
  seed=1,
  prior=c(set_prior(&quot;&quot;, class=&quot;Intercept&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>print(brms39)</code></pre>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: germination | trials(size) ~ solar + nutrition 
##    Data: dat39 (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept        -8.01      0.51    -9.06    -7.06 1.00     1471     1545
## solarsunshine     4.04      0.29     3.50     4.62 1.00     1803     1951
## nutrition         0.72      0.05     0.62     0.83 1.00     1737     1944
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>結果
<ul>
<li>solarsunshineの効果あり</li>
<li>nutritionの効果あり</li>
</ul></li>
<li>ただし、係数の解釈に注意が必要（リンク関数がロジット関数だから）</li>
<li>オッズ比：<span class="math inline">\(オッズ=\frac{p}{1-p}\)</span></li>
<li>ロジスティック回帰モデルの係数＝対数オッズ比
<ul>
<li>係数にexp()をかけるとオッズ比になる</li>
</ul></li>
<li>例を使ってオッズ比の説明 *日光と栄養素が発芽に与える影響。データ3つ。
<ul>
<li>やってみる</li>
</ul></li>
</ul>
<pre class="r"><code>egdata&lt;-data.frame(
  solar=c(&#39;shade&#39;,&#39;sunshine&#39;,&#39;sunshine&#39;),
  nutrition=c(2,2,3),
  size=c(10,10,10)
)
egdata</code></pre>
<pre><code>##      solar nutrition size
## 1    shade         2   10
## 2 sunshine         2   10
## 3 sunshine         3   10</code></pre>
<pre class="r"><code>linear_fit&lt;-fitted(brms39, egdata, scale=&#39;linear&#39;)[,1] # 最後の[,1]は1列目のみという意味
fit&lt;-1/(1+exp(-linear_fit))
fit</code></pre>
<pre><code>## [1] 0.00139586 0.07375353 0.14043054</code></pre>
<pre><code>* ここまでやったこと
  * データ（日照の有無、栄養素の量、個数を指定）
  * fitted関数を使って、データに対してさっき推定したモデルを適用、線形予測子の予測値を知る（linear_fitted）。
    * fitted関数についてはちょっと調べてみたけど、詳細は不明。&#39;linear&#39;ではなく&#39;response&#39;を指定するとロジスティック関数に入れた値に近い値が出てくるけど、ちょっと違う。
  * 線形予測子が出す値をロジスティック関数に与えることで、各データに対する発芽率が得られる（fit）。</code></pre>
<pre class="r"><code>odds_1 &lt;- fit[1]/(1-fit[1])
odds_2 &lt;- fit[2]/(1-fit[2])
odds_3 &lt;- fit[3]/(1-fit[3])</code></pre>
<ul>
<li>この後、オッズ比を算出する
<ul>
<li>odds_2/odds_1: 1と2の違いは日照の有無なので、日照によって成功率がどう変わるかが分かることになる</li>
<li>で、この値が日照の係数のexpと同じと言っている</li>
</ul></li>
</ul>
<pre class="r"><code>odds_2/odds_1</code></pre>
<pre><code>## [1] 56.96496</code></pre>
<pre class="r"><code>coef&lt;-fixef(brms39)[,1] 
exp(coef[&quot;solarsunshine&quot;])</code></pre>
<pre><code>## solarsunshine 
##      56.96496</code></pre>
<ul>
<li>確かに同じになる</li>
</ul>
</div>
<div id="回帰曲線の図示-1" class="section level2">
<h2>7. 回帰曲線の図示</h2>
<ul>
<li>図示。これまで同様。ただし、引数conditionsが必要（本のサポートページに記述あり）。</li>
</ul>
<pre class="r"><code>eff&lt;-conditional_effects(brms39, effects=&#39;nutrition:solar&#39;, conditions=data.frame(size=10))
plot(eff, points=TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-39-1.png" width="768" /></p>
<ul>
<li>せっかくなので予測区間も書いてみる</li>
</ul>
<pre class="r"><code>eff_pre&lt;-conditional_effects(brms39, effects=&#39;nutrition:solar&#39;, conditions=data.frame(size=10), method=&#39;predict&#39;)
plot(eff_pre, points=TRUE)</code></pre>
<p><img src="baba3_files/figure-html/unnamed-chunk-40-1.png" width="768" /> * ポアソン回帰同様、こちらもギザギザに。二項分布に従う乱数は整数だからという解釈でOK？ * ところで、「○○回帰モデル」命名の謎 * ポアソン分布に従うデータのモデル推定を、リンク関数を対数関数で実施する（線形予測子をexpで処理）→これをポアソン回帰と呼ぶ * 二項分布に従うデータのモデル推定を、リンク関数をロジット関数で実施する（線形予測子をlogisticで処理）→これをロジスティック回帰と呼ぶ * なんで？</p>
</div>
<div id="補足-ロジスティック回帰のためのstanファイルの実装" class="section level2">
<h2>8. 補足: ロジスティック回帰のためのStanファイルの実装</h2>
<ul>
<li>Stanでもやってみる。デザイン行列で。</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K;
  int Y[N];
  int binom_size[N];
  matrix[N, K] X;
}
parameters{
  vector[K] b;
}
model{
  vector[N] prob = X * b;
  Y ~ binomial_logit(binom_size, prob); #binomial_logitには引数2つ必要
}</code></pre>
<pre class="r"><code>dat39&lt;-read.csv(&#39;3-9-1-germination.csv&#39;)
formula39&lt;-formula(germination|size~solar+nutrition)
mtx39&lt;-model.matrix(formula39, dat39)
standatamtx39&lt;-list(
  N=nrow(dat39),
  K=3,
  binom_size=dat39$size,
  Y=dat39$germination,
  X=mtx39
)
resmtx39&lt;-rstan::sampling(stanmodel39, data=standatamtx39, seed=1)
print(resmtx39)</code></pre>
<pre><code>## Inference for Stan model: eece9cdab6a9b9c6fb30c3ecedf18040.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##         mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## b[1]   -7.99    0.02 0.51   -8.98   -8.35   -7.97   -7.61   -7.04   662    1
## b[2]    4.02    0.01 0.29    3.48    3.82    4.01    4.22    4.60   806    1
## b[3]    0.72    0.00 0.05    0.61    0.68    0.72    0.76    0.82   727    1
## lp__ -303.25    0.03 1.15 -306.14 -303.81 -302.99 -302.39 -301.85  1505    1
## 
## Samples were drawn using NUTS(diag_e) at Wed Mar  9 18:18:27 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>##9. 補足: 試行回数が常に1の場合 * そういうときは二項分布ではなくベルヌーイ分布を使おうね、という話</p>
</div>
</div>
</div>

   
   
              </div>
  </div>
  </div>
  </div>
   
      

  <script>
    $(document).ready(function () {

		// add bootstrap table styles to pandoc tables
	$('tr.header').parent('thead').parent('table').addClass('table table-condensed');
		
 		
	    });
  </script>



    <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
	document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>
  
</body>
</html>
