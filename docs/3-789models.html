<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />

        <meta name="author" content="Toshihide Imaruoka" />
    
    
    <title>馬場本3/10</title>

        <script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
        <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="site_libs/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <script src="site_libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
        <script src="site_libs/navigation-1.1/tabsets.js"></script>
        <link href="site_libs/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
        <script src="site_libs/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
        <link href="site_libs/downcute-0.1/downcute.css" rel="stylesheet" />
        <link href="site_libs/downcute-0.1/downcute_fonts_embed.css" rel="stylesheet" />
        <script src="site_libs/downcute-0.1/downcute_styles.js"></script>
        <script src="site_libs/downcute-0.1/downcute.js"></script>
        <script src="site_libs/prism-1.22/prism.js"></script>
    
    
    
        <link rel="stylesheet" href="mycss.css" type="text/css" />
    
    <!-- tabsets -->
    <script>
      $(document).ready(function () {
	  window.buildTabsets("toc");
      });
      $(document).ready(function () {
	  $('.tabset-dropdown > .nav-tabs > li').click(function () {
	      $(this).parent().toggleClass('nav-tabs-open')
	  });
      });
    </script>

    <!-- code folding -->
    
    <!-- code download -->
    
    <!-- tabsets dropdown -->

    <style type="text/css">
      .tabset-dropdown > .nav-tabs {
	  display: inline-table;
	  max-height: 500px;
	  min-height: 44px;
	  overflow-y: auto;
	  background: white;
	  border: 1px solid #ddd;
	  border-radius: 4px;
      }
      
      .tabset-dropdown > .nav-tabs > li.active:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
	  content: "&#xe258;";
	  border: none;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs > li.active {
	  display: block;
      }

      .tabset-dropdown > .nav-tabs > li.active a {
  	  padding: 0 15px !important;
      }

      .tabset-dropdown > .nav-tabs > li > a,
      .tabset-dropdown > .nav-tabs > li > a:focus,
      .tabset-dropdown > .nav-tabs > li > a:hover {
	  border: none;
	  display: inline-block;
	  border-radius: 4px;
	  background-color: transparent;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
	  display: block;
	  float: none;
      }
      
      .tabset-dropdown > .nav-tabs > li {
	  display: none;
	  margin-left: 0 !important;
      }
    </style>
    
</head>

<body class="preload">

   	
               <!-- downcute start -->   
   <div id="docute" class="Root theme-default">
     <div class="Page layout-narrow">
      <div class="Wrap">
        <div class="Sidebar">
          <div class="SidebarItems" id="toc">
            <ul>
            <li><a href="#正規線形モデル">3-7: 正規線形モデル</a>
            <ul>
            <li><a href="#モデルの構造">2. モデルの構造</a></li>
            <li><a href="#分析の準備">3. 分析の準備</a></li>
            <li><a href="#データの読み込み">4. データの読み込み</a></li>
            <li><a href="#brmsによる正規線形モデルの推定">5. brmsによる正規線形モデルの推定</a></li>
            <li><a href="#補足正規線形モデルのデザイン行列stanによる解析">6. 補足：正規線形モデルのデザイン行列（Stanによる解析）</a></li>
            </ul></li>
            <li><a href="#ポアソン回帰モデル">3-8: ポアソン回帰モデル</a>
            <ul>
            <li><a href="#モデルの構造-1">2. モデルの構造</a></li>
            <li><a href="#分析の準備-1">3. 分析の準備</a></li>
            <li><a href="#データの読み込みと可視化">4. データの読み込みと可視化</a></li>
            <li><a href="#brmsによるポアソン回帰モデルの推定">5. brmsによるポアソン回帰モデルの推定</a></li>
            <li><a href="#推定されたモデルの解釈">6. 推定されたモデルの解釈</a></li>
            <li><a href="#回帰曲線の図示">7. 回帰曲線の図示</a></li>
            <li><a href="#補足ポアソン回帰モデルのためのstanファイルの実装">8. 補足：ポアソン回帰モデルのためのStanファイルの実装</a></li>
            </ul></li>
            <li><a href="#ロジスティック回帰モデル">3-9. ロジスティック回帰モデル</a>
            <ul>
            <li><a href="#モデルの構造-2">2. モデルの構造</a></li>
            <li><a href="#分析の準備-2">3. 分析の準備</a></li>
            <li><a href="#データの読み込みと可視化-1">4. データの読み込みと可視化</a></li>
            <li><a href="#brmsによるロジスティック回帰モデルの推定">5. brmsによるロジスティック回帰モデルの推定</a></li>
            <li><a href="#回帰曲線の図示-1">7. 回帰曲線の図示</a></li>
            <li><a href="#補足-ロジスティック回帰のためのstanファイルの実装">8. 補足: ロジスティック回帰のためのStanファイルの実装</a></li>
            <li><a href="#補足-試行回数が常に1の場合">9. 補足: 試行回数が常に1の場合</a></li>
            </ul></li>
            <li><a href="#練習">練習</a></li>
            </ul>
          </div>
          <div data-position="sidebar:post-end" class="InjectedComponents"><div class="dark-theme-toggler"><div class="toggle "><div class="toggle-track"><div class="toggle-track-check"><img  src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div> <div class="toggle-track-x"><img src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16"></div></div> <div class="toggle-thumb"></div></div> <input type="checkbox" aria-label="Switch between Dark and Default theme" class="toggler-screen-reader-only"></div></div>
        </div>
        <div class="Main">
          <div class="Content" id="content"> 
   
   
      
      <div class="navbar navbar-default  navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">my public memo</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li>
        <a href="index.html">Home</a>
      </li>
      <li>
        <a href="baba1.html">馬場本1章</a>
      </li>
      <li>
        <a href="baba2.html">馬場本2章</a>
      </li>
      <li>
        <a href="baba3.html">馬場本3章</a>
      </li>
      <li>
        <a href="psytech.html">技術部</a>
      </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container -->
      </div><!--/.navbar -->
        
      <h1 class="title">馬場本3/10</h1>
      
      <p class="authors">
           <span class="glyphicon glyphicon-user"></span> Toshihide Imaruoka
      </p>
              

   
      
   
<!-- Don't indent these lines or it will mess pre blocks indentation --> 
<div class="page-content has-page-title">
<div id="正規線形モデル" class="section level1">
<h1>3-7: 正規線形モデル</h1>
<div id="モデルの構造" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>正規線形モデル：リンク関数が恒等関数であるモデルの総称</li>
<li>ここで使うモデル
<ul>
<li><span class="math inline">\(売り上げの平均値=晴れ＋雨＋気温\)</span></li>
<li><span class="math inline">\(\mu_i=\beta_0+\beta_1x_{i1}+\beta_2x_{i2}+\beta_3x_{i3}\)</span></li>
<li><span class="math inline">\(y_i\sim Normal(\mu_i, \sigma^2)\)</span></li>
</ul></li>
</ul>
</div>
<div id="分析の準備" class="section level2">
<h2>3. 分析の準備</h2>
<ul>
<li>いつもの</li>
</ul>
<pre class="r"><code>library(rstan)</code></pre>
<pre><code>##  要求されたパッケージ StanHeaders をロード中です</code></pre>
<pre><code>##  要求されたパッケージ ggplot2 をロード中です</code></pre>
<pre><code>## rstan (Version 2.21.3, GitRev: 2e1f913d3ca3)</code></pre>
<pre><code>## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)</code></pre>
<pre class="r"><code>library(brms)</code></pre>
<pre><code>##  要求されたパッケージ Rcpp をロード中です</code></pre>
<pre><code>## Loading &#39;brms&#39; package (version 2.16.3). Useful instructions
## can be found by typing help(&#39;brms&#39;). A more detailed introduction
## to the package is available through vignette(&#39;brms_overview&#39;).</code></pre>
<pre><code>## 
##  次のパッケージを付け加えます: &#39;brms&#39;</code></pre>
<pre><code>##  以下のオブジェクトは &#39;package:rstan&#39; からマスクされています: 
## 
##      loo</code></pre>
<pre><code>##  以下のオブジェクトは &#39;package:stats&#39; からマスクされています: 
## 
##      ar</code></pre>
<pre class="r"><code>rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())</code></pre>
</div>
<div id="データの読み込み" class="section level2">
<h2>4. データの読み込み</h2>
<ul>
<li>天気と気温が売り上げの平均値に影響するというモデルのためのデータ</li>
</ul>
<pre class="r"><code>data37&lt;-read.csv(&#39;3-7-1-beer-sales-4.csv&#39;)
summary(data37)</code></pre>
<pre><code>##      sales          weather           temperature   
##  Min.   : 26.06   Length:150         Min.   :10.10  
##  1st Qu.: 61.19   Class :character   1st Qu.:14.82  
##  Median : 80.55   Mode  :character   Median :19.00  
##  Mean   : 79.58                      Mean   :19.91  
##  3rd Qu.: 96.11                      3rd Qu.:25.35  
##  Max.   :137.57                      Max.   :29.80</code></pre>
<pre class="r"><code>ggplot(data=data37,
       mapping=aes(x=temperature, y=sales))+
      geom_point(aes(color=weather))+labs(title=&quot;effect of temperature and weather on beer sales&quot;)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-2-1.png" width="768" /></p>
</div>
<div id="brmsによる正規線形モデルの推定" class="section level2">
<h2>5. brmsによる正規線形モデルの推定</h2>
<pre class="r"><code>brms37&lt;-brm(
  formula = sales ~ weather + temperature,
  family = gaussian(),
  data = data37,
  seed = 1,
  prior = c(set_prior(&quot;&quot;, class=&quot;Intercept&quot;),
            set_prior(&quot;&quot;, class=&quot;sigma&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brms37</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: sales ~ weather + temperature 
##    Data: data37 (Number of observations: 150) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept       20.22      5.00    10.25    30.16 1.00     4702     2446
## weatherrainy    -3.51      3.16    -9.84     2.81 1.00     4491     3314
## weathersunny    29.45      3.19    23.29    35.60 1.00     4266     3036
## temperature      2.55      0.22     2.10     2.98 1.00     4292     2734
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma    16.07      0.96    14.29    18.08 1.00     4621     2692
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>eff&lt;-conditional_effects(brms37, effect=&quot;temperature:weather&quot;)
plot(eff, points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-3-1.png" width="768" /></p>
<pre class="r"><code>eff_pre&lt;-conditional_effects(brms37, effect=&quot;temperature:weather&quot;, method=&quot;predict&quot;)
plot(eff_pre, points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-3-2.png" width="768" /></p>
<ul>
<li>weathersunnyの推定値が29.45（信用区間は0をまたがない）: 晴れの日には＋29万円の効果</li>
<li>temperatureの推定値が2.55（信用区間は0をまたがない）：気温1℃で2.55万円増加</li>
</ul>
</div>
<div id="補足正規線形モデルのデザイン行列stanによる解析" class="section level2">
<h2>6. 補足：正規線形モデルのデザイン行列（Stanによる解析）</h2>
<ul>
<li>まずはbrmsによる解析からstanファイルを生成してみる</li>
</ul>
<pre class="r"><code>stancode(brms37)</code></pre>
<pre><code>## // generated with brms 2.16.3
## functions {
## }
## data {
##   int&lt;lower=1&gt; N;  // total number of observations
##   vector[N] Y;  // response variable
##   int&lt;lower=1&gt; K;  // number of population-level effects
##   matrix[N, K] X;  // population-level design matrix
##   int prior_only;  // should the likelihood be ignored?
## }
## transformed data {
##   int Kc = K - 1;
##   matrix[N, Kc] Xc;  // centered version of X without an intercept
##   vector[Kc] means_X;  // column means of X before centering
##   for (i in 2:K) {
##     means_X[i - 1] = mean(X[, i]);
##     Xc[, i - 1] = X[, i] - means_X[i - 1];
##   }
## }
## parameters {
##   vector[Kc] b;  // population-level effects
##   real Intercept;  // temporary intercept for centered predictors
##   real&lt;lower=0&gt; sigma;  // dispersion parameter
## }
## transformed parameters {
## }
## model {
##   // likelihood including constants
##   if (!prior_only) {
##     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);
##   }
##   // priors including constants
## }
## generated quantities {
##   // actual population-level intercept
##   real b_Intercept = Intercept - dot_product(means_X, b);
## }</code></pre>
<ul>
<li>続いて3部4章のStanファイル</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K; //デザイン行列列数
  vector[N] Y; //売り上げを代入するベクトル
  matrix[N, K] X; //デザイン行列
}
parameters{
  vector[K] b;
  real&lt;lower=0&gt; sigma;
}
model{
  vector[N] mu = X * b;
  Y ~ normal(mu, sigma);
}</code></pre>
<ul>
<li>Stanコードを実行</li>
</ul>
<pre class="r"><code># デザイン行列
formula37&lt;-formula(sales ~ weather + temperature)
mtx37&lt;-model.matrix(formula37, data37) ## data37はcsvファイルを読み込んだデータ

standata37&lt;-list(
  N=nrow(data37),
  K=4, # 切片、天気雨、天気晴れ、気温
  Y=data37$sales,
  X=mtx37
)

library(rstan)
stanres37&lt;-rstan::sampling(stan37,
                           data=standata37,
                           seed=1)
stanres37</code></pre>
<pre><code>## Inference for Stan model: 18eae6a6d0f7ded641090096a30443de.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##          mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## b[1]    20.12    0.11 5.01   10.21   16.84   20.08   23.38   30.08  1947    1
## b[2]    -3.53    0.06 3.20   -9.80   -5.64   -3.53   -1.41    2.96  2514    1
## b[3]    29.46    0.06 3.19   23.33   27.29   29.39   31.61   35.94  2432    1
## b[4]     2.55    0.00 0.22    2.12    2.41    2.55    2.69    2.99  2215    1
## sigma   16.05    0.02 0.96   14.36   15.39   15.99   16.65   18.09  2741    1
## lp__  -487.95    0.04 1.65 -492.03 -488.75 -487.59 -486.75 -485.82  1515    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Mar 10 13:40:58 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<ul>
<li>brmsとほぼ同じ結果になった</li>
</ul>
</div>
</div>
<div id="ポアソン回帰モデル" class="section level1">
<h1>3-8: ポアソン回帰モデル</h1>
<div id="モデルの構造-1" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>ポアソン分布：離散型で0以上の整数データのとき
<ul>
<li>パラメータ<span class="math inline">\(\lambda\)</span></li>
<li>期待値も分散も<span class="math inline">\(\lambda\)</span></li>
<li>リンク関数は<span class="math inline">\(log\)</span></li>
</ul></li>
<li>ここでの例
<ul>
<li>釣り</li>
<li>釣果＝天気＋気温
<ul>
<li>ただしポアソン分布を考えるので</li>
<li><span class="math inline">\(log(\lambda) = \beta_0 + \beta_1x_1 + \beta_2x_2\)</span>
<ul>
<li><span class="math inline">\(個人的には\lambda_i = exp(\beta_0 + \beta_1x_1 + \beta_2x_2)\)</span>の方が理解しやすい（と、3-1でも書いた。緑本にはこう書いてある。）</li>
</ul></li>
<li><span class="math inline">\(y_i \sim Poiss(\lambda_i)\)</span></li>
<li>馬場本では<span class="math inline">\(log(\lambda)=\)</span>の式もあって、下の式もあるのが分かりにくい感じがする
<ul>
<li><span class="math inline">\(\lambda = \beta_0 + \beta_1x_1 + \beta_2x_2\)</span></li>
<li><span class="math inline">\(y_i \sim Poiss(exp(\lambda_i))\)</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="分析の準備-1" class="section level2">
<h2>3. 分析の準備</h2>
<ul>
<li>いつもの</li>
</ul>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())</code></pre>
</div>
<div id="データの読み込みと可視化" class="section level2">
<h2>4. データの読み込みと可視化</h2>
<pre class="r"><code>data38&lt;-read.csv(&quot;3-8-1-fish-num-1.csv&quot;)
summary(data38)</code></pre>
<pre><code>##     fish_num     weather           temperature   
##  Min.   :0.0   Length:100         Min.   : 0.20  
##  1st Qu.:0.0   Class :character   1st Qu.: 6.75  
##  Median :1.0   Mode  :character   Median :13.25  
##  Mean   :1.6                      Mean   :14.75  
##  3rd Qu.:2.0                      3rd Qu.:23.23  
##  Max.   :8.0                      Max.   :29.70</code></pre>
<pre class="r"><code>ggplot(data=data38,
       mapping=aes(x=temperature, y=fish_num))+
  geom_point(aes(color=weather))+
  labs(title=&quot;effect of temperature and weather on num of fishes&quot;)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
</div>
<div id="brmsによるポアソン回帰モデルの推定" class="section level2">
<h2>5. brmsによるポアソン回帰モデルの推定</h2>
<ul>
<li>正規線形モデルとほぼ同じだけど、sigmaの事前分布の指定がない（推定しないから）</li>
</ul>
<pre class="r"><code>brms38&lt;-brm(
  formula = fish_num ~ weather + temperature,
  family=poisson(),
  data=data38,
  seed=1,
  prior=c(set_prior(&quot;&quot;,class=&quot;Intercept&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brms38</code></pre>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: fish_num ~ weather + temperature 
##    Data: data38 (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept       -0.78      0.23    -1.25    -0.33 1.00     2667     2348
## weathersunny    -0.60      0.17    -0.93    -0.28 1.00     2763     2437
## temperature      0.08      0.01     0.06     0.10 1.00     2849     2663
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div id="推定されたモデルの解釈" class="section level2">
<h2>6. 推定されたモデルの解釈</h2>
<ul>
<li>weathersunnyの係数の推定値は-0.60
<ul>
<li>ただし、exp(-0.60)=0.5488</li>
<li>晴れると0.54倍になる
<ul>
<li>倍でいいの？と思ったけど、expの中の足し算は掛け算。</li>
</ul></li>
</ul></li>
<li>temperatureは0.08
<ul>
<li>exp(0.08)=1.0832</li>
<li>晴れると微妙に増える</li>
</ul></li>
<li>釣果数の期待値<span class="math inline">\(\lambda=exp(-.78-0.60 \times 晴れかどうか+0.08 \times 気温)\)</span></li>
</ul>
</div>
<div id="回帰曲線の図示" class="section level2">
<h2>7. 回帰曲線の図示</h2>
<ul>
<li>95%ベイズ信用区間つき</li>
</ul>
<pre class="r"><code>eff38&lt;-conditional_effects(brms38,
                          effects=&quot;temperature:weather&quot;) # weatherを前にすれば横軸がweatherになる
plot(eff38, points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-9-1.png" width="768" /></p>
<ul>
<li>予測区間
<ul>
<li>過分散となることがある
<ul>
<li>期待値と分散が一つのパラメータで決まるから、とあるけど、なぜ？</li>
<li>緑本で「過分散」を調べてみる
<ul>
<li>P149脚注: 「現実のカウントデータでは平均よりも分散の方が大きくなる場合がほとんどです。詳しくは7.6節（以下略）」</li>
<li>P165 7.6節: ここでは過分散の原因として個体差を挙げている。種子数の例を使っていて、本来正規分布する植物の大きさが観測されていないため、という理屈。緑本的にはここから一般化線形混合モデル（GLMM）を使うという流れ。</li>
<li>馬場本でも第4分階層ベイズ（一般化線形混合モデル）と進む</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<pre class="r"><code>set.seed(1)
eff_pre38&lt;-conditional_effects(brms38,
                              method=&#39;predict&#39;,
                              effects=&#39;temperature:weather&#39;,
                              probs=c(0.05, 0.995))</code></pre>
<pre><code>## Warning: Argument &#39;probs&#39; is deprecated. Please use &#39;prob&#39; instead.</code></pre>
<pre class="r"><code>plot(eff_pre38, points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-10-1.png" width="768" /></p>
</div>
<div id="補足ポアソン回帰モデルのためのstanファイルの実装" class="section level2">
<h2>8. 補足：ポアソン回帰モデルのためのStanファイルの実装</h2>
<ul>
<li>ここでもStanファイルから実行してみる</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int fish_num[N];
  vector[N] temp;
  vector[N] sunny;
}
parameters{
  real Intercept;
  real b_temp;
  real b_sunny;
}
model{
  vector[N] lambda=exp(Intercept + b_sunny*sunny + b_temp*temp);
  fish_num~poisson(lambda);
}</code></pre>
<ul>
<li>上のStanファイルを実行
<ul>
<li>下の計算ではデータからダミー変数を作ったけど、それをやる必要はない？</li>
</ul></li>
</ul>
<pre class="r"><code>data38&lt;-read.csv(&#39;3-8-1-fish-num-1.csv&#39;) #データ読み込み
data38$sunny&lt;-as.integer(data38$weather==&#39;sunny&#39;) # 晴れの日ダミー変数作成
standata38&lt;-list(  # Stanに渡すためにリストにまとめる
  N=nrow(data38),
  fish_num=data38$fish_num,
  temp=data38$temp,
  sunny=data38$sunny
)

res38&lt;-rstan::sampling(stan38, data=standata38, seed=1)
print(res38)</code></pre>
<pre><code>## Inference for Stan model: e329c84b9dafccadcdc4bd4254c33f37.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##             mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## Intercept  -0.81    0.01 0.25  -1.31  -0.97  -0.80  -0.64  -0.34  1114    1
## b_temp      0.08    0.00 0.01   0.06   0.08   0.08   0.09   0.10  1083    1
## b_sunny    -0.58    0.00 0.17  -0.91  -0.70  -0.58  -0.47  -0.26  1978    1
## lp__      -37.73    0.03 1.25 -40.98 -38.28 -37.41 -36.85 -36.33  1344    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Mar 10 13:41:32 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<ul>
<li>デザイン行列バージョンも一応。</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K;
  int Y[N];
  matrix[N, K] X;
}
parameters{
  vector[K] b;
}
model{
  vector[N] lambda = X * b;
  Y ~ poisson_log(lambda);
}</code></pre>
<ul>
<li>この下で使ってるformula関数、model.matrix関数が結構謎。model.matrixは名義尺度のweatherからダミー変数weathersunnyを自動的に生成しているように見える。</li>
</ul>
<pre class="r"><code>data38&lt;-read.csv(&#39;3-8-1-fish-num-1.csv&#39;) #データ読み込み
formula38&lt;-formula(fish_num~weather+temperature)
mtx38&lt;-model.matrix(formula38, data38)
standatamtx38&lt;-list(
  N=nrow(data38),
  K=3,
  Y=data38$fish_num,
  X=mtx38
)
resmtx38&lt;-rstan::sampling(modelmtx38, data=standatamtx38, seed=1)
print(resmtx38)</code></pre>
<pre><code>## Inference for Stan model: 4c43339f9706b3c93aef14ebdf915da2.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##        mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## b[1]  -0.79    0.01 0.24  -1.28  -0.96  -0.78  -0.63  -0.36  1328    1
## b[2]  -0.59    0.00 0.16  -0.92  -0.70  -0.59  -0.48  -0.26  1751    1
## b[3]   0.08    0.00 0.01   0.06   0.08   0.08   0.09   0.10  1414    1
## lp__ -37.65    0.03 1.19 -40.79 -38.17 -37.35 -36.79 -36.32  1416    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Mar 10 13:41:48 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
</div>
<div id="ロジスティック回帰モデル" class="section level1">
<h1>3-9. ロジスティック回帰モデル</h1>
<div id="モデルの構造-2" class="section level2">
<h2>2. モデルの構造</h2>
<ul>
<li>2値データ</li>
<li>種子が発芽するかしないか
<ul>
<li>発芽率<span class="math inline">\(p\)</span></li>
<li>確率分布：二項分布</li>
<li>リンク関数：ロジット関数</li>
<li><span class="math inline">\(p_i\)</span>: 発芽確率</li>
<li><span class="math inline">\(y_i\)</span>: 10粒中の発芽数</li>
<li><span class="math inline">\(x_{i1}\)</span>: 日当たり有無のダミー変数</li>
<li><span class="math inline">\(x_{i2}\)</span>: 栄養素量</li>
<li><span class="math inline">\(p_i = logostic(\beta_0+\beta_1x_{i1}+\beta_2{xi})\)</span> :パラメータ<span class="math inline">\(p\)</span>は0から1の間で変化するロジスティック関数に従う</li>
<li><span class="math inline">\(y_i\sim Binom(10, p_i)\)</span></li>
</ul></li>
</ul>
</div>
<div id="分析の準備-2" class="section level2">
<h2>3. 分析の準備</h2>
<pre class="r"><code>library(rstan)
library(brms)
rstan_options(auto_write=TRUE)
options(mc.cores=parallel::detectCores())</code></pre>
</div>
<div id="データの読み込みと可視化-1" class="section level2">
<h2>4. データの読み込みと可視化</h2>
<pre class="r"><code>dat39&lt;-read.csv(&#39;3-9-1-germination.csv&#39;)
summary(dat39)</code></pre>
<pre><code>##   germination         size       solar             nutrition   
##  Min.   : 0.00   Min.   :10   Length:100         Min.   : 1.0  
##  1st Qu.: 0.00   1st Qu.:10   Class :character   1st Qu.: 3.0  
##  Median : 1.00   Median :10   Mode  :character   Median : 5.5  
##  Mean   : 2.83   Mean   :10                      Mean   : 5.5  
##  3rd Qu.: 4.00   3rd Qu.:10                      3rd Qu.: 8.0  
##  Max.   :10.00   Max.   :10                      Max.   :10.0</code></pre>
<pre class="r"><code>ggplot(data=dat39, 
       mapping=aes(x=nutrition, y=germination, color=solar)) + geom_point() + labs(title=&#39;relation between germination and solar and nutrition&#39;)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-14-1.png" width="768" /></p>
</div>
<div id="brmsによるロジスティック回帰モデルの推定" class="section level2">
<h2>5. brmsによるロジスティック回帰モデルの推定</h2>
<pre class="r"><code>brms39&lt;-brm(
  germination | trials(size) ~ solar + nutrition,
  family = binomial(),
  data=dat39,
  seed=1,
  prior=c(set_prior(&quot;&quot;, class=&quot;Intercept&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>print(brms39)</code></pre>
<pre><code>##  Family: binomial 
##   Links: mu = logit 
## Formula: germination | trials(size) ~ solar + nutrition 
##    Data: dat39 (Number of observations: 100) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept        -8.01      0.51    -9.06    -7.06 1.00     1471     1545
## solarsunshine     4.04      0.29     3.50     4.62 1.00     1803     1951
## nutrition         0.72      0.05     0.62     0.83 1.00     1737     1944
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>結果
<ul>
<li>solarsunshineの効果あり</li>
<li>nutritionの効果あり</li>
</ul></li>
<li>ただし、係数の解釈に注意が必要（リンク関数がロジット関数だから）</li>
<li>オッズ比：<span class="math inline">\(オッズ=\frac{p}{1-p}\)</span></li>
<li>ロジスティック回帰モデルの係数＝対数オッズ比
<ul>
<li>係数にexp()をかけるとオッズ比になる</li>
</ul></li>
<li>例を使ってオッズ比の説明 *日光と栄養素が発芽に与える影響。データ3つ。
<ul>
<li>やってみる</li>
</ul></li>
</ul>
<pre class="r"><code>egdata&lt;-data.frame(
  solar=c(&#39;shade&#39;,&#39;sunshine&#39;,&#39;sunshine&#39;),
  nutrition=c(2,2,3),
  size=c(10,10,10)
)
egdata</code></pre>
<pre><code>##      solar nutrition size
## 1    shade         2   10
## 2 sunshine         2   10
## 3 sunshine         3   10</code></pre>
<pre class="r"><code>linear_fit&lt;-fitted(brms39, egdata, scale=&#39;linear&#39;)[,1] # 最後の[,1]は1列目のみという意味
fit&lt;-1/(1+exp(-linear_fit))
fit</code></pre>
<pre><code>## [1] 0.00139586 0.07375353 0.14043054</code></pre>
<ul>
<li>ここまでやったこと
<ul>
<li>データ（日照の有無、栄養素の量、個数を指定）</li>
<li>fitted関数を使って、データに対してさっき推定したモデルを適用、線形予測子の予測値を知る（linear_fitted）。</li>
<li>fitted関数についてはちょっと調べてみたけど、詳細は不明。’linear’ではなく’response’を指定するとロジスティック関数に入れた値に近い値が出てくるけど、ちょっと違う。</li>
<li>線形予測子が出す値をロジスティック関数に与えることで、各データに対する発芽率が得られる（fit）。</li>
</ul></li>
</ul>
<pre class="r"><code>odds_1 &lt;- fit[1]/(1-fit[1])
odds_2 &lt;- fit[2]/(1-fit[2])
odds_3 &lt;- fit[3]/(1-fit[3])</code></pre>
<ul>
<li>この後、オッズ比を算出する
<ul>
<li>odds_2/odds_1: 1と2の違いは日照の有無なので、日照によって成功率がどう変わるかが分かることになる</li>
<li>で、この値が日照の係数のexpと同じと言っている</li>
</ul></li>
</ul>
<pre class="r"><code>odds_2/odds_1</code></pre>
<pre><code>## [1] 56.96496</code></pre>
<pre class="r"><code>coef&lt;-fixef(brms39)[,1] 
exp(coef[&quot;solarsunshine&quot;])</code></pre>
<pre><code>## solarsunshine 
##      56.96496</code></pre>
<ul>
<li>確かに同じになる</li>
</ul>
</div>
<div id="回帰曲線の図示-1" class="section level2">
<h2>7. 回帰曲線の図示</h2>
<ul>
<li>図示。これまで同様。ただし、引数conditionsが必要（本のサポートページに記述あり）。</li>
</ul>
<pre class="r"><code>eff&lt;-conditional_effects(brms39, effects=&#39;nutrition:solar&#39;, conditions=data.frame(size=10))
plot(eff, points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-19-1.png" width="768" /></p>
<ul>
<li>せっかくなので予測区間も書いてみる</li>
</ul>
<pre class="r"><code>eff_pre&lt;-conditional_effects(brms39, effects=&#39;nutrition:solar&#39;, conditions=data.frame(size=10), method=&#39;predict&#39;)
plot(eff_pre, points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-20-1.png" width="768" /> * ポアソン回帰同様、こちらもギザギザに。二項分布に従う乱数は整数だからという解釈でOK？ * ところで、「○○回帰モデル」命名の謎 * ポアソン分布に従うデータのモデル推定を、リンク関数を対数関数で実施する（線形予測子をexpで処理）→これをポアソン回帰と呼ぶ * 二項分布に従うデータのモデル推定を、リンク関数をロジット関数で実施する（線形予測子をlogisticで処理）→これをロジスティック回帰と呼ぶ * なんで？</p>
</div>
<div id="補足-ロジスティック回帰のためのstanファイルの実装" class="section level2">
<h2>8. 補足: ロジスティック回帰のためのStanファイルの実装</h2>
<ul>
<li>Stanでもやってみる。デザイン行列で。</li>
</ul>
<pre class="stan"><code>data{
  int N;
  int K;
  int Y[N];
  int binom_size[N];
  matrix[N, K] X;
}
parameters{
  vector[K] b;
}
model{
  vector[N] prob = X * b;
  Y ~ binomial_logit(binom_size, prob); #binomial_logitには引数2つ必要
}</code></pre>
<pre class="r"><code>dat39&lt;-read.csv(&#39;3-9-1-germination.csv&#39;)
formula39&lt;-formula(germination|size~solar+nutrition)
mtx39&lt;-model.matrix(formula39, dat39)
standatamtx39&lt;-list(
  N=nrow(dat39),
  K=3,
  binom_size=dat39$size,
  Y=dat39$germination,
  X=mtx39
)
resmtx39&lt;-rstan::sampling(stanmodel39, data=standatamtx39, seed=1)
print(resmtx39)</code></pre>
<pre><code>## Inference for Stan model: eece9cdab6a9b9c6fb30c3ecedf18040.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##         mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## b[1]   -7.99    0.02 0.51   -8.98   -8.35   -7.97   -7.61   -7.04   662    1
## b[2]    4.02    0.01 0.29    3.48    3.82    4.01    4.22    4.60   806    1
## b[3]    0.72    0.00 0.05    0.61    0.68    0.72    0.76    0.82   727    1
## lp__ -303.25    0.03 1.15 -306.14 -303.81 -302.99 -302.39 -301.85  1505    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Mar 10 13:42:24 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</div>
<div id="補足-試行回数が常に1の場合" class="section level2">
<h2>9. 補足: 試行回数が常に1の場合</h2>
<ul>
<li>そういうときは二項分布ではなくベルヌーイ分布を使おうね、という話</li>
</ul>
</div>
</div>
<div id="練習" class="section level1">
<h1>練習</h1>
<ul>
<li>今年の基礎実験2の視覚探索実験の結果
<ul>
<li>2要因（セットサイズ、難易度）</li>
<li>従属変数：反応時間（秒）</li>
<li>データ：vsres.csv</li>
</ul></li>
</ul>
<pre class="r"><code>library(brms)
library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✓ tibble  3.1.6     ✓ dplyr   1.0.7
## ✓ tidyr   1.1.4     ✓ stringr 1.4.0
## ✓ readr   2.1.2     ✓ forcats 0.5.1
## ✓ purrr   0.3.4</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x tidyr::extract() masks rstan::extract()
## x dplyr::filter()  masks stats::filter()
## x dplyr::lag()     masks stats::lag()</code></pre>
<pre class="r"><code>dat&lt;-read.csv(&#39;vsres.csv&#39;, check.names=FALSE)
longdat&lt;-dat %&gt;% pivot_longer(!ID, names_to = c(&quot;dif&quot;,&quot;ss&quot;), values_to = &quot;RT&quot;, names_sep = &#39; &#39;)
ggplot(data=longdat, mapping=aes(x=ss,y=RT,color=dif))+geom_violin()</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-22-1.png" width="768" /></p>
<pre class="r"><code>brmvs&lt;-brm(
  RT ~ ss + dif,
  family = shifted_lognormal(),
  data = longdat,
  prior=c(set_prior(&quot;&quot;, class=&quot;Intercept&quot;, &quot;&quot;),
          set_prior(&quot;&quot;, class=&quot;sigma&quot;))
)</code></pre>
<pre><code>## Compiling Stan program...</code></pre>
<pre><code>## Trying to compile a simple C file</code></pre>
<pre><code>## Running /usr/local/Cellar/r/4.1.2/lib/R/bin/R CMD SHLIB foo.c
## clang -I&quot;/usr/local/Cellar/r/4.1.2/lib/R/include&quot; -DNDEBUG   -I&quot;/usr/local/lib/R/4.1/site-library/Rcpp/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppEigen/include/unsupported&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/BH/include&quot; -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/src/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/&quot;  -I&quot;/usr/local/lib/R/4.1/site-library/RcppParallel/include/&quot;  -I&quot;/Users/imaru/Library/R/x86_64/4.1/library/rstan/include&quot; -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include &#39;/Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp&#39;  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/opt/gettext/include -I/usr/local/opt/readline/include -I/usr/local/opt/xz/include -I/usr/local/include   -fPIC  -Wno-implicit-function-declaration  -c foo.c -o foo.o
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:88:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name &#39;namespace&#39;
## namespace Eigen {
## ^
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:16: error: expected &#39;;&#39; after top level declarator
## namespace Eigen {
##                ^
##                ;
## In file included from &lt;built-in&gt;:1:
## In file included from /Users/imaru/Library/R/x86_64/4.1/library/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13:
## In file included from /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Dense:1:
## /usr/local/lib/R/4.1/site-library/RcppEigen/include/Eigen/Core:96:10: fatal error: &#39;complex&#39; file not found
## #include &lt;complex&gt;
##          ^~~~~~~~~
## 3 errors generated.
## make: *** [foo.o] Error 1</code></pre>
<pre><code>## Start sampling</code></pre>
<pre class="r"><code>brmvs</code></pre>
<pre><code>##  Family: shifted_lognormal 
##   Links: mu = identity; sigma = identity; ndt = identity 
## Formula: RT ~ ss + dif 
##    Data: longdat (Number of observations: 120) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.26      0.07    -0.39    -0.14 1.00     2272     2649
## ss18          0.25      0.07     0.10     0.40 1.00     2293     2431
## ss6          -0.25      0.07    -0.40    -0.11 1.00     2338     2651
## diflow       -1.61      0.12    -1.83    -1.38 1.00     1225     1663
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.33      0.03     0.27     0.40 1.01     1260     1864
## ndt       0.37      0.02     0.33     0.40 1.01     1090     1355
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>eff&lt;-conditional_effects(brmvs, effects=&#39;ss:dif&#39;)
plot(eff,points=TRUE)</code></pre>
<p><img src="3-789models_files/figure-html/unnamed-chunk-22-2.png" width="768" /></p>
</div>
</div>

   
   
              </div>
  </div>
  </div>
  </div>
   
      

  <script>
    $(document).ready(function () {

		// add bootstrap table styles to pandoc tables
	$('tr.header').parent('thead').parent('table').addClass('table table-condensed');
		
 		
	    });
  </script>



    <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
	document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>
  
</body>
</html>
